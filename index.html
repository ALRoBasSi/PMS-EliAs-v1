<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>نظام ادارة المنتجات v2.4.0 - نظام الحقول الديناميكي</title>
  
  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#1c1c1c">
  <meta name="description" content="تطبيق احترافي لإدارة المنتجات والمخزون مع نظام حقول متقدم">
  <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIlB1c2hkYXJhaCBQcm9kdWN0IE1hbmFnZXIiLAogICJzaG9ydF9uYW1lIjogIlB1c2hkYXJhaCIsCiAgInN0YXJ0X3VybCI6ICIvIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjMWMxYzFjIiwKICAidGhlbWVfY29sb3IiOiAiIzRhOWVmZiIKfQ==">
  
  <!-- Font Awesome Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- Google Fonts - Arabic -->
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
  
  <!-- Hijri Date Library -->
  <script src="https://cdn.jsdelivr.net/npm/hijri-date@2.2.2/dist/hijri-date.min.js"></script>
  
  <style>
    /* ===== CSS Variables & Reset ===== */
    :root {
      /* Light Mode Colors */
      --bg-primary: #f8fafc;
      --bg-secondary: #ffffff;
      --bg-tertiary: #f1f5f9;
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --text-tertiary: #94a3b8;
      --text-inverse: #ffffff;
      --border-color: #e2e8f0;
      --border-hover: #cbd5e1;
      --card-bg: #ffffff;
      --card-shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
      --card-hover-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --header-bg: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
      --toolbar-bg: linear-gradient(135deg, #ffffff 0%, #f1f5f9 100%);
      --accent: #3b82f6;
      --accent-hover: #2563eb;
      --accent-light: #dbeafe;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --transition-speed: 0.3s;
      --border-radius: 12px;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --font-family: "Tajawal", "Noto Naskh Arabic", sans-serif;
      --input-bg: #ffffff;
      
      /* Grid System */
      --gutter: 1rem;
      --container-max-width: 1200px;
    }

    /* Dark Mode */
    body.dark-mode {
      --bg-primary: #1c1c1c;
      --bg-secondary: #2a2a2a;
      --bg-tertiary: #404040;
      --text-primary: #ffffff;
      --text-secondary: #e5e5e5;
      --text-tertiary: #b3b3b3;
      --text-inverse: #1c1c1c;
      --border-color: #404040;
      --border-hover: #5a5a5a;
      --card-bg: #2a2a2a;
      --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.7), 0 2px 4px -1px rgba(0, 0, 0, 0.5);
      --card-hover-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.8), 0 10px 10px -5px rgba(0, 0, 0, 0.6);
      --header-bg: linear-gradient(135deg, #2a2a2a 0%, #1c1c1c 100%);
      --toolbar-bg: linear-gradient(135deg, #2a2a2a 0%, #404040 100%);
      --accent: #4a9eff;
      --accent-hover: #6bb3ff;
      --accent-light: #1e3a8a;
      --success: #4ade80;
      --danger: #f87171;
      --warning: #fbbf24;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.5);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.6), 0 2px 4px -1px rgba(0, 0, 0, 0.5);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.7), 0 4px 6px -2px rgba(0, 0, 0, 0.6);
      --input-bg: #2a2a2a;
    }

    /* Reset & Base Styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      transition: background-color var(--transition-speed) ease,
                  color var(--transition-speed) ease,
                  border-color var(--transition-speed) ease,
                  box-shadow var(--transition-speed) ease;
    }

    html {
      font-size: 16px;
      direction: rtl;
    }

    body {
      background: var(--bg-primary);
      color: var(--text-primary);
      font-family: var(--font-family);
      line-height: 1.6;
      padding-bottom: 70px;
      min-height: 100vh;
    }

    /* ===== Layout System ===== */
    .container {
      width: 100%;
      max-width: var(--container-max-width);
      margin: 0 auto;
      padding: 0 var(--gutter);
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      margin: 0 calc(var(--gutter) * -0.5);
    }

    .col {
      flex: 1 0 0%;
      padding: 0 calc(var(--gutter) * 0.5);
    }

    .col-1 { flex: 0 0 8.333333%; max-width: 8.333333%; }
    .col-2 { flex: 0 0 16.666667%; max-width: 16.666667%; }
    .col-3 { flex: 0 0 25%; max-width: 25%; }
    .col-4 { flex: 0 0 33.333333%; max-width: 33.333333%; }
    .col-5 { flex: 0 0 41.666667%; max-width: 41.666667%; }
    .col-6 { flex: 0 0 50%; max-width: 50%; }
    .col-7 { flex: 0 0 58.333333%; max-width: 58.333333%; }
    .col-8 { flex: 0 0 66.666667%; max-width: 66.666667%; }
    .col-9 { flex: 0 0 75%; max-width: 75%; }
    .col-10 { flex: 0 0 83.333333%; max-width: 83.333333%; }
    .col-11 { flex: 0 0 91.666667%; max-width: 91.666667%; }
    .col-12 { flex: 0 0 100%; max-width: 100%; }

    /* ===== Utility Classes ===== */
    .d-flex { display: flex; }
    .d-none { display: none; }
    .d-block { display: block; }
    .d-grid { display: grid; }

    .flex-column { flex-direction: column; }
    .flex-wrap { flex-wrap: wrap; }
    .flex-1 { flex: 1; }

    .justify-content-between { justify-content: space-between; }
    .justify-content-center { justify-content: center; }
    .justify-content-end { justify-content: flex-end; }
    .justify-content-around { justify-content: space-around; }

    .align-items-center { align-items: center; }
    .align-items-start { align-items: flex-start; }
    .align-items-end { align-items: flex-end; }

    .text-center { text-align: center; }
    .text-right { text-align: right; }
    .text-left { text-align: left; }

    .w-100 { width: 100%; }
    .h-100 { height: 100%; }

    .m-0 { margin: 0; }
    .mb-0 { margin-bottom: 0; }
    .mb-1 { margin-bottom: 0.25rem; }
    .mb-2 { margin-bottom: 0.5rem; }
    .mb-3 { margin-bottom: 1rem; }
    .mb-4 { margin-bottom: 1.5rem; }
    .mb-5 { margin-bottom: 3rem; }

    .mt-0 { margin-top: 0; }
    .mt-1 { margin-top: 0.25rem; }
    .mt-2 { margin-top: 0.5rem; }
    .mt-3 { margin-top: 1rem; }
    .mt-4 { margin-top: 1.5rem; }

    .me-1 { margin-left: 0.25rem; }
    .me-2 { margin-left: 0.5rem; }
    .me-3 { margin-left: 1rem; }
    .me-4 { margin-left: 1.5rem; }

    .ms-1 { margin-right: 0.25rem; }
    .ms-2 { margin-right: 0.5rem; }
    .ms-3 { margin-right: 1rem; }

    .p-0 { padding: 0; }
    .p-1 { padding: 0.25rem; }
    .p-2 { padding: 0.5rem; }
    .p-3 { padding: 1rem; }
    .p-4 { padding: 1.5rem; }
    .p-5 { padding: 3rem; }

    .gap-1 { gap: 0.25rem; }
    .gap-2 { gap: 0.5rem; }
    .gap-3 { gap: 1rem; }
    .gap-4 { gap: 1.5rem; }
    .gap-5 { gap: 3rem; }

    .position-relative { position: relative; }
    .position-absolute { position: absolute; }
    .position-fixed { position: fixed; }
    .position-sticky { position: sticky; }

    /* ===== Components ===== */

    /* App Header */
    .app-header {
      background: var(--header-bg);
      border-bottom: 1px solid var(--border-color);
      padding: 1rem;
      box-shadow: var(--shadow-sm);
      position: sticky;
      top: 0;
      z-index: 1030;
    }

    .app-header h1 {
      font-size: 1.5rem;
      font-weight: 700;
      margin: 0;
      color: var(--text-primary);
    }

    .app-header .subtitle {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin: 0;
    }

    /* Mobile Toolbar */
    .mobile-toolbar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--toolbar-bg);
      border-top: 1px solid var(--border-color);
      padding: 0.5rem 0;
      box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.1);
      z-index: 1050;
      display: flex;
      justify-content: space-around;
    }

    .toolbar-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: none;
      color: var(--text-secondary);
      padding: 0.5rem;
      border-radius: 8px;
      transition: all var(--transition-speed) ease;
      cursor: pointer;
      position: relative;
      min-width: 60px;
      flex: 1;
    }

    .toolbar-btn:hover {
      background: var(--bg-tertiary);
      color: var(--accent);
    }

    .toolbar-btn.active {
      color: var(--accent);
      background: var(--accent-light);
    }

    .toolbar-btn i {
      font-size: 1.25rem;
      margin-bottom: 0.25rem;
    }

    .toolbar-btn span {
      font-size: 0.7rem;
      font-weight: 500;
    }

    /* Page Content */
    .page-content {
      padding: 1rem;
      min-height: calc(100vh - 140px);
    }

    .page {
      display: none;
    }

    .page.active {
      display: block;
      animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Cards */
    .card {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      box-shadow: var(--card-shadow);
      margin-bottom: 1rem;
      overflow: hidden;
    }

    .card:hover {
      box-shadow: var(--card-hover-shadow);
    }

    .card-header {
      background: var(--bg-tertiary);
      border-bottom: 1px solid var(--border-color);
      padding: 0.75rem 1rem;
      font-weight: 600;
    }

    .card-body {
      padding: 1rem;
    }

    /* Product Cards */
    .product-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1rem;
    }

    .product-grid.list-view {
      grid-template-columns: 1fr;
    }

    .product-card {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      overflow: hidden;
      transition: all var(--transition-speed) ease;
      cursor: pointer;
    }

    .product-card.list-view {
      display: flex;
      flex-direction: row;
      height: 120px;
    }

    .product-card.list-view .product-image {
      width: 100px;
      height: 100%;
      flex-shrink: 0;
      object-fit: cover;
    }

    .product-card.list-view .product-details {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: 0.5rem;
      min-width: 0;
    }

    .product-card.list-view .product-name {
      font-size: 0.9rem;
      margin-bottom: 0.25rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .product-card.list-view .product-price {
      font-size: 1rem;
      margin-bottom: 0.25rem;
    }

    .product-card.list-view .product-category {
      font-size: 0.75rem;
      margin-bottom: 0.25rem;
    }

    .product-card.list-view .product-actions {
      margin-top: auto;
      display: flex;
      gap: 0.25rem;
    }

    .product-card.list-view .product-actions .btn {
      padding: 0.25rem 0.5rem;
      font-size: 0.7rem;
    }

    .product-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--card-hover-shadow);
    }

    .product-image {
      width: 100%;
      height: 180px;
      object-fit: cover;
      background: var(--bg-tertiary);
    }

    .product-details {
      padding: 1rem;
    }

    .product-name {
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--text-primary);
    }

    .product-price {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 0.5rem;
    }

    .product-category {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
    }

    .product-actions {
      display: flex;
      gap: 0.5rem;
    }

    /* Forms */
    .form-control, .form-select {
      background-color: var(--input-bg);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 0.75rem;
      transition: all var(--transition-speed) ease;
      width: 100%;
      font-family: inherit;
      font-size: inherit;
    }

    .form-control:focus, .form-select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      outline: none;
    }

    .form-label {
      color: var(--text-primary);
      font-weight: 500;
      margin-bottom: 0.5rem;
      display: block;
    }

    .form-check {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .form-check-input {
      margin: 0;
    }

    /* Buttons */
    .btn {
      padding: 0.75rem 1rem;
      border-radius: 8px;
      font-weight: 500;
      transition: all var(--transition-speed) ease;
      cursor: pointer;
      border: none;
      font-family: inherit;
      font-size: 0.875rem;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .btn-primary {
      background: var(--accent);
      color: white;
    }

    .btn-primary:hover {
      background: var(--accent-hover);
      transform: translateY(-1px);
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-success:hover {
      background: #0da271;
      transform: translateY(-1px);
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-danger:hover {
      background: #dc2626;
      transform: translateY(-1px);
    }

    .btn-outline-secondary {
      background: transparent;
      border: 1px solid var(--border-color);
      color: var(--text-secondary);
    }

    .btn-outline-secondary:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }

    .btn-sm {
      padding: 0.5rem 0.75rem;
      font-size: 0.75rem;
    }

    .btn-xs {
      padding: 0.25rem 0.5rem;
      font-size: 0.7rem;
    }

    /* Search Bar - IMPROVED FOR MOBILE */
    .search-container {
      position: relative;
      margin-bottom: 1rem;
      display: flex;
      gap: 0.5rem;
      align-items: stretch;
      flex-wrap: nowrap;
    }

    .search-input-container {
      position: relative;
      flex: 1;
      min-width: 0;
    }

    .search-input {
      width: 100%;
      padding: 0.75rem 1rem 0.75rem 2.5rem;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background: var(--input-bg);
      color: var(--text-primary);
      font-size: 0.9rem;
    }

    .search-icon {
      position: absolute;
      right: 0.75rem;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-tertiary);
      z-index: 2;
    }

    .search-controls {
      display: flex;
      gap: 0.25rem;
      flex-shrink: 0;
    }

    /* Stats Cards - Material Design style */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
      align-items: stretch;
    }

    .stat-card {
      position: relative;
      background: var(--card-bg);
      border-radius: 12px;
      padding: 1rem;
      text-align: center;
      box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.08);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      transition: box-shadow var(--transition-speed) ease, transform var(--transition-speed) ease;
      overflow: hidden;
      min-height: 100px;
    }

    .stat-card:hover {
      transform: translateY(-6px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.14), 0 3px 6px rgba(0,0,0,0.06);
    }

    .stat-icon {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: var(--accent);
      color: #fff;
      font-size: 1.05rem;
      margin-bottom: 0.5rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.12);
    }

    .stat-value {
      font-size: 1.6rem;
      font-weight: 800;
      color: var(--text-primary);
      margin-bottom: 0.25rem;
      letter-spacing: 0.2px;
    }

    .stat-label {
      font-size: 0.85rem;
      color: var(--text-secondary);
      font-weight: 600;
    }

    /* Mobile adjustments */
    @media (max-width: 575.98px) {
      .stats-grid { grid-template-columns: repeat(2, 1fr); gap: 0.6rem; }
      .stat-card { padding: 0.75rem; min-height: 80px; }
      .stat-icon { width: 38px; height: 38px; font-size: 0.95rem; }
      .stat-value { font-size: 1.3rem; }
      .stat-label { font-size: 0.8rem; }
    }

    /* Alerts */
    .alert {
      padding: 1rem;
      border-radius: var(--border-radius);
      margin-bottom: 1rem;
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
    }

    .alert-info {
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.2);
      color: var(--accent);
    }

    .alert-warning {
      background: rgba(245, 158, 11, 0.1);
      border: 1px solid rgba(245, 158, 11, 0.2);
      color: var(--warning);
    }

    .alert i {
      font-size: 1.25rem;
      flex-shrink: 0;
    }

    /* Badges */
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.5rem;
      font-size: 0.75rem;
      font-weight: 600;
      border-radius: 4px;
      white-space: nowrap;
    }

    .bg-primary {
      background: var(--accent);
      color: white;
    }

    .bg-secondary {
      background: var(--text-secondary);
      color: white;
    }

    .bg-info {
      background: var(--accent-light);
      color: var(--accent);
    }

    /* List Group */
    .list-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .list-group-item {
      padding: 0.75rem 1rem;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      transition: all var(--transition-speed) ease;
    }

    .list-group-item:hover {
      background: var(--bg-tertiary);
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
      color: var(--text-secondary);
    }

    .empty-state i {
      font-size: 3rem;
      margin-bottom: 1rem;
      color: var(--text-tertiary);
    }

    .empty-state h3 {
      margin-bottom: 0.5rem;
      color: var(--text-primary);
    }

    .empty-state p {
      margin-bottom: 0.5rem;
    }

    /* Modals */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1060;
      opacity: 0;
      visibility: hidden;
      transition: opacity var(--transition-speed) ease, visibility var(--transition-speed) ease;
    }

    .modal.active {
      opacity: 1;
      visibility: visible;
    }

    .modal-content {
      background: var(--card-bg);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-lg);
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      transform: scale(0.9);
      transition: transform var(--transition-speed) ease;
    }

    .modal.active .modal-content {
      transform: scale(1);
    }

    .modal-header {
      padding: 1rem;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-weight: 600;
      color: var(--text-primary);
      margin: 0;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 0;
      width: 2rem;
      height: 2rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-body {
      padding: 1rem;
    }

    .modal-footer {
      padding: 1rem;
      border-top: 1px solid var(--border-color);
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
    }

    /* Toast Notifications */
    .toast-container {
      position: fixed;
      top: 1rem;
      left: 1rem;
      right: 1rem;
      z-index: 1070;
    }

    .toast {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-lg);
      padding: 1rem;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      transform: translateY(-100%);
      opacity: 0;
      transition: transform var(--transition-speed) ease, opacity var(--transition-speed) ease;
    }

    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }

    .toast-icon {
      font-size: 1.25rem;
    }

    .toast.success .toast-icon {
      color: var(--success);
    }

    .toast.error .toast-icon {
      color: var(--danger);
    }

    .toast.warning .toast-icon {
      color: var(--warning);
    }

    .toast-message {
      flex: 1;
      color: var(--text-primary);
    }

    /* Category Tree */
    .category-tree-view {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .category-tree-node {
      margin-bottom: 0.5rem;
    }

    .category-tree-node-content {
      display: flex;
      align-items: center;
      padding: 0.75rem 1rem;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: all var(--transition-speed) ease;
    }

    .category-tree-node-content:hover {
      background: var(--bg-tertiary);
      box-shadow: var(--shadow-sm);
    }

    .category-tree-node-content.main-category {
      font-weight: 600;
      background: var(--bg-secondary);
    }

    .category-tree-node-toggle {
      margin-left: 0.5rem;
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      transition: transform var(--transition-speed) ease;
      padding: 0.25rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .category-tree-node-toggle.expanded {
      transform: rotate(90deg);
    }

    .category-tree-node-children {
      margin-right: 2rem;
      margin-top: 0.5rem;
      padding-right: 1rem;
      border-right: 2px solid var(--border-color);
      display: none;
    }

    .category-tree-node-children.expanded {
      display: block;
    }

    /* Settings */
    .settings-section {
      margin-bottom: 1.5rem;
    }

    .settings-title {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .settings-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 0;
      border-bottom: 1px solid var(--border-color);
    }

    .settings-item:last-child {
      border-bottom: none;
    }

    .settings-label {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .settings-label i {
      font-size: 1.1rem;
      color: var(--accent);
    }

    .settings-text {
      display: flex;
      flex-direction: column;
    }

    .settings-name {
      font-weight: 500;
      color: var(--text-primary);
    }

    .settings-desc {
      font-size: 0.8rem;
      color: var(--text-secondary);
      margin-top: 0.25rem;
    }

    /* Theme Switch */
    .theme-switch {
      position: relative;
      width: 50px;
      height: 26px;
      background: var(--border-color);
      border-radius: 13px;
      cursor: pointer;
      transition: background-color var(--transition-speed) ease;
    }

    .theme-switch.active {
      background: var(--accent);
    }

    .theme-switch-slider {
      position: absolute;
      top: 3px;
      right: 3px;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      transition: transform var(--transition-speed) ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .theme-switch.active .theme-switch-slider {
      transform: translateX(-24px);
    }

    /* Spinner */
    .spinner-container {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 200px;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border-color);
      border-top: 3px solid var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Additional Components */
    .category-management {
      background: var(--card-bg);
      border-radius: var(--border-radius);
      box-shadow: var(--card-shadow);
      margin-bottom: 1rem;
    }

    .category-type-tabs {
      display: flex;
      border-bottom: 1px solid var(--border-color);
    }

    .category-type-tab {
      padding: 0.75rem 1rem;
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all var(--transition-speed) ease;
      border-bottom: 2px solid transparent;
    }

    .category-type-tab.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
    }

    .category-type-tab:hover {
      color: var(--text-primary);
    }

    .category-list {
      max-height: 400px;
      overflow-y: auto;
    }

    .category-list-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      border-bottom: 1px solid var(--border-color);
      transition: background-color var(--transition-speed) ease;
    }

    .category-list-item:hover {
      background: var(--bg-tertiary);
    }

    .category-info {
      flex: 1;
    }

    .category-name {
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 0.25rem;
    }

    .category-meta {
      font-size: 0.875rem;
      color: var(--text-secondary);
    }

    .category-actions {
      display: flex;
      gap: 0.5rem;
    }

    .subcategory-item {
      background: var(--bg-tertiary);
      margin-right: 1rem;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      margin-bottom: 0.5rem;
    }

    .field-type-selector {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .field-type-option {
      padding: 0.5rem;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      text-align: center;
      cursor: pointer;
      transition: all var(--transition-speed) ease;
    }

    .field-type-option:hover {
      border-color: var(--accent);
      background: var(--accent-light);
    }

    .field-type-option.selected {
      border-color: var(--accent);
      background: var(--accent);
      color: white;
    }

    .dropdown-options {
      margin-top: 0.5rem;
    }

    .dropdown-option {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem;
      background: var(--bg-tertiary);
      border-radius: 6px;
      margin-bottom: 0.5rem;
    }

    .dropdown-option input {
      flex: 1;
      border: none;
      background: transparent;
      color: var(--text-primary);
    }

    .dropdown-option input:focus {
      outline: none;
    }

    .dropdown-option button {
      background: none;
      border: none;
      color: var(--danger);
      cursor: pointer;
    }

    /* Dynamic Form Fields */
    .dynamic-field {
      margin-bottom: 1rem;
      padding: 1rem;
      background: var(--bg-tertiary);
      border-radius: 8px;
      border: 1px solid var(--border-color);
    }

    .dynamic-field-label {
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .dynamic-field-label .field-type-badge {
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
      background: var(--accent);
      color: white;
      border-radius: 4px;
    }

    /* Field Preview */
    .field-preview {
      margin-top: 1rem;
      padding: 1rem;
      background: var(--bg-tertiary);
      border-radius: var(--border-radius);
      border: 1px dashed var(--border-color);
    }

    .field-preview-title {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
    }

    /* Validation Errors */
    .validation-errors {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid var(--danger);
      border-radius: var(--border-radius);
      padding: 0.75rem;
      margin-bottom: 1rem;
    }

    .validation-errors ul {
      margin: 0;
      padding-right: 1.5rem;
      color: var(--danger);
    }

    /* View Controls - IMPROVED FOR MOBILE */
    .view-controls {
      display: flex;
      gap: 0.25rem;
      flex-shrink: 0;
    }

    .view-control {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 0.5rem;
      cursor: pointer;
      transition: all var(--transition-speed) ease;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
    }

    .view-control.active {
      background: var(--accent);
      color: white;
    }

    .view-control:hover {
      background: var(--bg-tertiary);
    }

    /* Barcode Search Button - IMPROVED FOR MOBILE */
    .barcode-search-btn {
      padding: 0.5rem;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all var(--transition-speed) ease;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      flex-shrink: 0;
    }

    .barcode-search-btn:hover {
      background: var(--bg-tertiary);
      color: var(--accent);
    }

    /* Extra Fields Management */
    .extra-fields-section {
      margin-top: 1rem;
      padding: 1rem;
      background: var(--bg-tertiary);
      border-radius: 8px;
    }

    .extra-field-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem;
      background: var(--card-bg);
      border-radius: 6px;
      margin-bottom: 0.5rem;
    }

    .extra-field-info {
      flex: 1;
    }

    .extra-field-name {
      font-weight: 600;
      color: var(--text-primary);
    }

    .extra-field-type {
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    .extra-field-actions {
      display: flex;
      gap: 0.25rem;
    }

    /* Barcode Scanner */
    .barcode-scanner {
      position: relative;
      width: 100%;
      height: 300px;
      background: var(--bg-tertiary);
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 1rem;
    }

    .barcode-scanner video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .barcode-scanner-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .barcode-scanner-frame {
      width: 200px;
      height: 100px;
      border: 2px solid var(--accent);
      border-radius: 8px;
      position: relative;
    }

    .barcode-scanner-frame::before,
    .barcode-scanner-frame::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      border: 2px solid var(--accent);
    }

    .barcode-scanner-frame::before {
      top: -2px;
      left: -2px;
      border-right: none;
      border-bottom: none;
    }

    .barcode-scanner-frame::after {
      bottom: -2px;
      right: -2px;
      border-left: none;
      border-top: none;
    }

    /* Confirmation Dialog */
    .confirmation-dialog {
      text-align: center;
      padding: 1rem;
    }

    .confirmation-dialog i {
      font-size: 3rem;
      color: var(--warning);
      margin-bottom: 1rem;
    }

    .confirmation-dialog h4 {
      margin-bottom: 1rem;
      color: var(--text-primary);
    }

    .confirmation-dialog p {
      margin-bottom: 1.5rem;
      color: var(--text-secondary);
    }

    /* Form Structure Editor Styles */
    .form-structure-editor {
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: 1rem;
      height: 600px;
    }

    .categories-list {
      background: var(--card-bg);
      border-radius: var(--border-radius);
      border: 1px solid var(--border-color);
      overflow: hidden;
    }

    .categories-list-header {
      padding: 1rem;
      border-bottom: 1px solid var(--border-color);
      background: var(--bg-tertiary);
    }

    .categories-list-items {
      max-height: 500px;
      overflow-y: auto;
    }

    .category-list-item {
      padding: 1rem;
      border-bottom: 1px solid var(--border-color);
      cursor: pointer;
      transition: all var(--transition-speed) ease;
    }

    .category-list-item:hover {
      background: var(--bg-tertiary);
    }

    .category-list-item.active {
      background: var(--accent-light);
      border-right: 3px solid var(--accent);
    }

    .fields-editor {
      background: var(--card-bg);
      border-radius: var(--border-radius);
      border: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
    }

    .fields-editor-header {
      padding: 1rem;
      border-bottom: 1px solid var(--border-color);
      background: var(--bg-tertiary);
    }

    .fields-list {
      flex: 1;
      padding: 1rem;
      overflow-y: auto;
      min-height: 400px;
    }

    .field-item {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 0.5rem;
      cursor: move;
      transition: all var(--transition-speed) ease;
    }

    .field-item:hover {
      border-color: var(--accent);
      box-shadow: var(--shadow-sm);
    }

    .field-item.dragging {
      opacity: 0.5;
      background: var(--accent-light);
    }

    .field-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .field-title {
      font-weight: 600;
      color: var(--text-primary);
    }

    .field-type {
      font-size: 0.8rem;
      color: var(--text-secondary);
      background: var(--bg-tertiary);
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
    }

    .field-actions {
      display: flex;
      gap: 0.25rem;
    }

    .field-preview-area {
      margin-top: 1rem;
      padding: 1rem;
      background: var(--bg-tertiary);
      border-radius: var(--border-radius);
      border: 1px dashed var(--border-color);
    }

    .form-preview {
      background: var(--bg-secondary);
      border-radius: var(--border-radius);
      padding: 1rem;
    }

    /* Sortable styles */
    .sortable-ghost {
      opacity: 0.4;
      background: var(--accent-light);
    }

    .sortable-chosen {
      background: var(--accent-light);
    }

    /* Field options styles */
    .field-options-list {
      margin-top: 0.5rem;
    }

    .field-option-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .field-option-item input {
      flex: 1;
    }

    /* ===== NEW: SLIDE CARDS DESIGN FOR CATEGORIES ===== */
    .categories-slider-container {
      position: relative;
      margin: 1rem 0;
    }

    .categories-slider {
      display: flex;
      overflow-x: auto;
      scroll-behavior: smooth;
      gap: 1rem;
      padding: 1rem 0.5rem;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .categories-slider::-webkit-scrollbar {
      display: none;
    }

    .slide-card {
      flex: 0 0 300px;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      padding: 1.5rem;
      transition: all var(--transition-speed) ease;
      cursor: pointer;
      position: relative;
      display: flex;
      flex-direction: column;
      min-height: 200px;
      box-shadow: var(--card-shadow);
    }

    .slide-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--card-hover-shadow);
      border-color: var(--accent);
    }

    .slide-card.active {
      border-color: var(--accent);
      background: var(--accent-light);
      transform: scale(1.02);
    }

    .slide-card-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: 1rem;
    }

    .slide-card-icon {
      width: 50px;
      height: 50px;
      border-radius: 12px;
      background: var(--accent-light);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--accent);
      font-size: 1.5rem;
      flex-shrink: 0;
    }

    .slide-card-actions {
      display: flex;
      gap: 0.5rem;
      opacity: 0;
      transition: opacity var(--transition-speed) ease;
    }

    .slide-card:hover .slide-card-actions {
      opacity: 1;
    }

    .slide-card-content {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .slide-card-title {
      font-weight: 700;
      font-size: 1.2rem;
      color: var(--text-primary);
      margin-bottom: 0.75rem;
      line-height: 1.3;
    }

    .slide-card-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .slide-card-stat {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      padding: 0.75rem;
      background: var(--bg-tertiary);
      border-radius: 8px;
    }

    .slide-stat-value {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--accent);
      line-height: 1;
    }

    .slide-stat-label {
      font-size: 0.8rem;
      color: var(--text-secondary);
      margin-top: 0.25rem;
    }

    .slide-card-subcategories {
      margin-top: auto;
    }

    .slide-subcategories-list {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .slide-subcategory-tag {
      background: var(--bg-tertiary);
      padding: 0.3rem 0.6rem;
      border-radius: 15px;
      font-size: 0.75rem;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 0.3rem;
      max-width: 120px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .slide-subcategory-tag .actions {
      display: flex;
      gap: 0.2rem;
      opacity: 0;
      transition: opacity var(--transition-speed) ease;
    }

    .slide-subcategory-tag:hover .actions {
      opacity: 1;
    }

    .slide-no-subcategories {
      font-size: 0.85rem;
      color: var(--text-tertiary);
      text-align: center;
      padding: 0.5rem;
    }

    .slide-card-footer {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px dashed var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .slide-card-date {
      font-size: 0.75rem;
      color: var(--text-tertiary);
    }

    /* Slider Navigation */
    .slider-nav {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 40px;
      height: 40px;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 10;
      transition: all var(--transition-speed) ease;
      box-shadow: var(--shadow-sm);
    }

    .slider-nav:hover {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }

    .slider-nav.prev {
      right: -20px;
    }

    .slider-nav.next {
      left: -20px;
    }

    .slider-nav.hidden {
      display: none;
    }

    /* Compact view for mobile */
    .slide-card.compact {
      flex: 0 0 280px;
      min-height: 180px;
      padding: 1.25rem;
    }

    .slide-card.compact .slide-card-title {
      font-size: 1.1rem;
    }

    .slide-card.compact .slide-card-stats {
      gap: 0.75rem;
    }

    .slide-card.compact .slide-stat-value {
      font-size: 1.2rem;
    }

    /* ===== Responsive Design ===== */
    @media (max-width: 575.98px) {
      .container {
        padding: 0 0.5rem;
      }
      
      .product-grid {
        grid-template-columns: 1fr;
      }
      
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .modal-content {
        width: 95%;
        margin: 1rem;
      }
      
      .mobile-toolbar {
        padding: 0.25rem 0;
      }
      
      .toolbar-btn span {
        font-size: 0.65rem;
      }
      
      .col-6, .col-12, .col-md-3, .col-md-4, .col-md-6 {
        flex: 0 0 100%;
        max-width: 100%;
      }

      .search-container {
        flex-direction: column;
        gap: 0.75rem;
      }

      .search-input-container {
        width: 100%;
      }

      .search-controls {
        width: 100%;
        justify-content: space-between;
      }

      .view-controls {
        gap: 0.5rem;
      }

      .view-control {
        width: 44px;
        height: 44px;
      }

      .barcode-search-btn {
        width: 44px;
        height: 44px;
      }

      .product-card.list-view {
        flex-direction: row;
        height: 110px;
      }

      .product-card.list-view .product-image {
        width: 90px;
        height: 100%;
      }

      .product-card.list-view .product-details {
        padding: 0.4rem;
      }

      .product-card.list-view .product-name {
        font-size: 0.85rem;
      }

      .product-card.list-view .product-price {
        font-size: 0.9rem;
      }

      .product-card.list-view .product-category {
        font-size: 0.7rem;
      }

      .product-card.list-view .product-actions {
        gap: 0.2rem;
      }

      .product-card.list-view .product-actions .btn {
        padding: 0.2rem 0.4rem;
        font-size: 0.65rem;
      }

      .form-structure-editor {
        grid-template-columns: 1fr;
        height: auto;
      }

      .categories-list {
        max-height: 300px;
      }

      /* Improved slide cards for mobile */
      .categories-slider {
        padding: 0.5rem 0.25rem;
        gap: 0.75rem;
      }

      .slide-card {
        flex: 0 0 260px;
        min-height: 170px;
        padding: 1rem;
      }

      .slide-card-title {
        font-size: 1rem;
      }

      .slide-card-stats {
        gap: 0.5rem;
      }

      .slide-stat-value {
        font-size: 1.1rem;
      }

      .slide-card-actions {
        opacity: 1; /* Always show actions on mobile */
      }

      .slider-nav {
        display: none; /* Hide navigation arrows on mobile */
      }

      .slide-subcategories-list {
        gap: 0.3rem;
      }

      .slide-subcategory-tag {
        font-size: 0.7rem;
        padding: 0.25rem 0.5rem;
      }
    }

    @media (min-width: 576px) and (max-width: 767.98px) {
      .product-grid {
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      }
      
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .col-md-3 {
        flex: 0 0 50%;
        max-width: 50%;
      }
      
      .col-md-4 {
        flex: 0 0 50%;
        max-width: 50%;
      }
      
      .col-md-6 {
        flex: 0 0 100%;
        max-width: 100%;
      }

      .search-container {
        flex-wrap: nowrap;
      }

      .search-input-container {
        min-width: 200px;
      }

      .search-controls {
        flex-shrink: 0;
      }

      .product-card.list-view {
        height: 120px;
      }

      .product-card.list-view .product-image {
        width: 100px;
      }

      .form-structure-editor {
        grid-template-columns: 250px 1fr;
      }

      /* Improved slide cards for tablet */
      .slide-card {
        flex: 0 0 280px;
      }
    }

    @media (min-width: 768px) and (max-width: 991.98px) {
      .product-grid {
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      }
      
      .stats-grid {
        grid-template-columns: repeat(4, 1fr);
      }
      
      .col-md-3 {
        flex: 0 0 25%;
        max-width: 25%;
      }
      
      .col-md-4 {
        flex: 0 0 33.333333%;
        max-width: 33.333333%;
      }
      
      .col-md-6 {
        flex: 0 0 50%;
        max-width: 50%;
      }

      .product-card.list-view {
        height: 130px;
      }

      .product-card.list-view .product-image {
        width: 110px;
      }
    }

    @media (min-width: 992px) {
      .product-grid {
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      }
      
      .page-content {
        padding: 2rem;
      }
      
      .col-md-3 {
        flex: 0 0 25%;
        max-width: 25%;
      }
      
      .col-md-4 {
        flex: 0 0 33.333333%;
        max-width: 33.333333%;
      }
      
      .col-md-6 {
        flex: 0 0 50%;
        max-width: 50%;
      }

      .product-card.list-view {
        height: 140px;
      }

      .product-card.list-view .product-image {
        width: 120px;
      }
    }

    /* Dark Mode Enhancements */
    body.dark-mode {
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
    }

    body.dark-mode h1, 
    body.dark-mode h2, 
    body.dark-mode h3, 
    body.dark-mode h4, 
    body.dark-mode h5, 
    body.dark-mode h6 {
      color: #ffffff;
      font-weight: 700;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.6);
    }

    body.dark-mode .form-control,
    body.dark-mode .form-select {
      background-color: #1c1c1c;
      color: #ffffff;
      border-color: #404040;
    }

    body.dark-mode .form-control:focus,
    body.dark-mode .form-select:focus {
      border-color: #4a9eff;
      box-shadow: 0 0 0 3px rgba(74, 158, 255, 0.4);
    }

    body.dark-mode .form-control::placeholder {
      color: #b3b3b3;
    }

    /* Dark mode enhancements for new slide cards */
    body.dark-mode .slide-card {
      background: var(--card-bg);
      border-color: var(--border-color);
    }

    body.dark-mode .slide-card:hover {
      border-color: var(--accent);
      background: var(--bg-secondary);
    }

    body.dark-mode .slide-card.active {
      background: var(--accent-light);
      border-color: var(--accent);
    }

    body.dark-mode .slide-subcategory-tag {
      background: var(--bg-tertiary);
      color: var(--text-secondary);
    }

    body.dark-mode .slide-card-stat {
      background: var(--bg-tertiary);
    }
  </style>
</head>
<body>
  <!-- App Header -->
  <header class="app-header">
    <div class="d-flex justify-content-between align-items-center">
      <div class="d-flex align-items-center" style="gap:12px;">
        <img id="storeLogoImg" src="" alt="logo" style="width:48px;height:48px;object-fit:contain;border-radius:8px;display:none;">
        <div>
          <h1 id="storeTitle">نظام ادارة المنتجات</h1>
          <p class="subtitle" id="storeSubtitle">مرجع المنتجات والمخزون المتقدم</p>
        </div>
      </div>
      <div class="d-flex align-items-center gap-2">
        <button class="btn btn-outline-secondary btn-sm" id="desktopSearchBtn">
          <i class="fas fa-search"></i>
        </button>
        <button class="btn btn-outline-secondary btn-sm" id="desktopThemeToggle">
          <i class="fas fa-moon" id="desktopThemeIcon"></i>
        </button>
      </div>
    </div>
  </header>

  <!-- Mobile Toolbar -->
  <nav class="mobile-toolbar">
    <button class="toolbar-btn active" data-page="home">
      <i class="fas fa-home"></i>
      <span>الرئيسية</span>
    </button>
    <button class="toolbar-btn" data-page="products">
      <i class="fas fa-box"></i>
      <span>المنتجات</span>
    </button>
    <button class="toolbar-btn" data-page="add">
      <i class="fas fa-plus-circle"></i>
      <span>إضافة</span>
    </button>
    <button class="toolbar-btn" data-page="categories">
      <i class="fas fa-folder"></i>
      <span>الفئات</span>
    </button>
    <button class="toolbar-btn" data-page="settings">
      <i class="fas fa-cog"></i>
      <span>الإعدادات</span>
    </button>
  </nav>

  <!-- Page Content -->
  <main class="page-content">
    <!-- Home Page -->
    <div id="homePage" class="page active">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon"><i class="fas fa-box" aria-hidden="true"></i></div>
          <div class="stat-value" id="totalProducts">0</div>
          <div class="stat-label">المنتجات</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon"><i class="fas fa-folder" aria-hidden="true"></i></div>
          <div class="stat-value" id="totalCategories">0</div>
          <div class="stat-label">الفئات</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon"><i class="fas fa-wallet" aria-hidden="true"></i></div>
          <div class="stat-value" id="totalValue">0</div>
          <div class="stat-label">القيمة الإجمالية</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon"><i class="fas fa-exclamation-triangle" aria-hidden="true"></i></div>
          <div class="stat-value" id="lowStock">0</div>
          <div class="stat-label">مخزون منخفض</div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">الإجراءات السريعة</h5>
        </div>
        <div class="card-body">
          <div class="row g-2">
            <div class="col-6 col-md-3">
              <button class="btn btn-primary w-100" id="quickAddProduct">
                <i class="fas fa-plus"></i> إضافة منتج
              </button>
            </div>
            <div class="col-6 col-md-3">
              <button class="btn btn-outline-secondary w-100" id="quickViewProducts">
                <i class="fas fa-box"></i> عرض المنتجات
              </button>
            </div>
            <div class="col-6 col-md-3">
              <button class="btn btn-outline-secondary w-100" id="quickManageCategories">
                <i class="fas fa-folder"></i> إدارة الفئات
              </button>
            </div>
            <div class="col-6 col-md-3">
              <button class="btn btn-outline-secondary w-100" id="quickBackup">
                <i class="fas fa-cloud-download"></i> نسخة احتياطية
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- بطاقة "نصائح واستخدام" أُزيلت بناءً على طلب المستخدم -->

      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">آخر النشاطات</h5>
        </div>
        <div class="card-body">
          <div id="recentActivities">
            <div class="empty-state">
              <i class="fas fa-clock"></i>
              <h3>لا توجد أنشطة حديثة</h3>
              <p>ستظهر هنا آخر العمليات التي قمت بها</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Products Page -->
    <div id="productsPage" class="page">
      <div class="search-container">
        <div class="search-input-container">
          <i class="fas fa-search search-icon"></i>
          <input type="text" class="search-input" id="productSearch" placeholder="ابحث عن منتج بالاسم، الكود، أو الفئة...">
        </div>
        <div class="search-controls">
          <button class="barcode-search-btn" id="barcodeSearchBtn" title="بحث بالباركود">
            <i class="fas fa-barcode"></i>
          </button>
          <div class="view-controls">
            <button class="view-control active" id="gridViewBtn" title="عرض شبكي">
              <i class="fas fa-th"></i>
            </button>
            <button class="view-control" id="listViewBtn" title="عرض قائمة">
              <i class="fas fa-list"></i>
            </button>
          </div>
        </div>
      </div>

      <div class="card mb-3">
        <div class="card-body">
          <div class="row g-2">
            <div class="col-12 col-md-4">
              <select class="form-select" id="categoryFilter">
                <option value="">جميع الفئات</option>
              </select>
            </div>
            <div class="col-12 col-md-4">
              <select class="form-select" id="priceFilter">
                <option value="">جميع الأسعار</option>
                <option value="0-100">أقل من 100</option>
                <option value="100-500">100 - 500</option>
                <option value="500-1000">500 - 1000</option>
                <option value="1000+">أكثر من 1000</option>
              </select>
            </div>
            <div class="col-12 col-md-4">
              <select class="form-select" id="sortBy">
                <option value="name">الاسم</option>
                <option value="price-asc">السعر (الأقل أولاً)</option>
                <option value="price-desc">السعر (الأعلى أولاً)</option>
                <option value="date">التاريخ</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <div id="productsContainer">
        <div class="spinner-container">
          <div class="spinner"></div>
        </div>
      </div>
    </div>

    <!-- Add Product Page -->
    <div id="addPage" class="page">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0" id="addProductTitle">إضافة منتج جديد</h5>
        </div>
        <div class="card-body">
          <form id="productForm">
            <div class="row g-3">
              <div class="col-12">
                <label class="form-label">اسم المنتج *</label>
                <input type="text" class="form-control" id="productName" required>
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label">الكود / SKU</label>
                <input type="text" class="form-control" id="productSku">
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label">الباركود</label>
                <input type="text" class="form-control" id="productBarcode">
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label">الفئة الرئيسية</label>
                <select class="form-select" id="productMainCategory" required>
                  <option value="">اختر الفئة الرئيسية</option>
                </select>
              </div>
              <div class="col-12">
                <label class="form-label">الملاحظات</label>
                <textarea class="form-control" id="productDescription" rows="3"></textarea>
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label">وحدة البيع</label>
                <select class="form-select" id="productUnit">
                  <option value="piece">قطعة</option>
                  <option value="meter">متر</option>
                  <option value="roll">لفة</option>
                  <option value="kg">كيلوجرام</option>
                </select>
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label" id="priceLabel">السعر *</label>
                <input type="number" class="form-control" id="productPrice" min="0" step="0.01" required>
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label" id="quantityLabel">الكمية</label>
                <input type="number" class="form-control" id="productQuantity" min="0">
              </div>
              <div class="col-12">
                <label class="form-label">صور المنتج</label>
                <input type="file" class="form-control" id="productImage" accept="image/*" multiple>
                <div id="imagePreview" class="mt-2"></div>
              </div>
              <!-- Dynamic Fields Container -->
              <div id="dynamicFieldsContainer"></div>
              <div class="col-12">
                <button type="submit" class="btn btn-success" id="submitProductBtn">
                  <i class="fas fa-check"></i> حفظ المنتج
                </button>
                <button type="button" class="btn btn-outline-secondary" id="resetForm">
                  <i class="fas fa-redo"></i> إعادة تعيين
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Categories Page - UPDATED WITH SLIDE CARDS DESIGN -->
    <div id="categoriesPage" class="page">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">محرر هيكل النماذج</h5>
          <div>
            <button class="btn btn-primary btn-sm" id="addCategoryBtn">
              <i class="fas fa-plus"></i> إضافة فئة
            </button>
            <button class="btn btn-success btn-sm" id="importStructureBtn">
              <i class="fas fa-file-import"></i> استيراد
            </button>
            <button class="btn btn-outline-secondary btn-sm" id="exportStructureBtn">
              <i class="fas fa-file-export"></i> تصدير
            </button>
          </div>
        </div>
        <div class="card-body">
          <!-- تم إزالة ملاحظة المعلومات هذه من محرر الفئات بناءً على طلب المستخدم -->
          
          <div class="form-structure-editor">
            <!-- Categories List -->
            <div class="categories-list">
              <div class="categories-list-header">
                <h6 class="mb-0">الفئات</h6>
              </div>
              <div class="categories-list-items" id="categoriesListItems">
                <!-- Categories will be rendered here with slide cards design -->
              </div>
            </div>
            
            <!-- Fields Editor -->
            <div class="fields-editor">
              <div class="fields-editor-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0" id="selectedCategoryTitle">اختر فئة</h6>
                <button class="btn btn-primary btn-sm" id="addFieldBtn" disabled>
                  <i class="fas fa-plus"></i> إضافة حقل
                </button>
              </div>
              <div class="fields-list" id="fieldsList">
                <div class="empty-state">
                  <i class="fas fa-folder-open"></i>
                  <h3>اختر فئة لبدء التحرير</h3>
                  <p>اختر فئة من القائمة على اليسار لإدارة حقولها</p>
                </div>
              </div>
              
              <!-- Form Preview -->
              <div class="field-preview-area">
                <div class="field-preview-title">معاينة النموذج</div>
                <div class="form-preview" id="formPreview">
                  <p class="text-muted text-center">ستظهر معاينة النموذج هنا</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Settings Page -->
    <div id="settingsPage" class="page">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">الإعدادات</h5>
        </div>
        <div class="card-body">
          <!-- Appearance Section -->
          <div class="settings-section">
            <div class="settings-title">المظهر</div>
            <div class="settings-item">
              <div class="settings-label">
                <i class="fas fa-moon"></i>
                <div class="settings-text">
                  <div class="settings-name">الوضع الليلي</div>
                  <div class="settings-desc">تغيير مظهر التطبيق إلى الوضع الداكن</div>
                </div>
              </div>
              <div class="theme-switch" id="settingsThemeSwitch">
                <div class="theme-switch-slider"></div>
              </div>
            </div>
            <div class="settings-item">
              <div class="settings-label">
                <i class="fas fa-palette"></i>
                <div class="settings-text">
                  <div class="settings-name">لون السمة</div>
                  <div class="settings-desc">اختر لون السمة المفضل</div>
                </div>
              </div>
              <select class="form-select" id="themeColor" style="width: 120px;">
                <option value="blue">أزرق</option>
                <option value="green">أخضر</option>
                <option value="purple">بنفسجي</option>
                <option value="red">أحمر</option>
              </select>
            </div>
            <div class="settings-item">
              <div class="settings-label">
                <i class="fas fa-money-bill-wave"></i>
                <div class="settings-text">
                  <div class="settings-name">العملة الأساسية</div>
                  <div class="settings-desc">تحديد العملة الافتراضية لعرض الأسعار</div>
                </div>
              </div>
              <select class="form-select" id="baseCurrencySelect" style="width: 200px;">
                <option value="SAR">🇸🇦 ريال سعودي (SAR)</option>
                <option value="USD">🇺🇸 دولار أمريكي (USD)</option>
                <option value="YER">🇾🇪 ريال يمني (YER)</option>
              </select>
              <small class="text-muted d-block mt-2" id="baseCurrencyHint"></small>
            </div>
            <!-- Calendar Type Setting -->
            <div class="settings-item">
              <div class="settings-label">
                <i class="fas fa-calendar"></i>
                <div class="settings-text">
                  <div class="settings-name">نوع التقويم</div>
                  <div class="settings-desc">اختر نوع التقويم المستخدم في النظام</div>
                </div>
              </div>
              <select class="form-select" id="calendarType" style="width: 120px;">
                <option value="gregorian">ميلادي</option>
                <option value="hijri">هجري</option>
              </select>
            </div>
          </div>

          <!-- Data Management Section -->
          <div class="settings-section">
            <div class="settings-title">إدارة البيانات</div>
            <div class="settings-item">
              <div class="settings-label">
                <i class="fas fa-cloud-download"></i>
                <div class="settings-text">
                  <div class="settings-name">نسخة احتياطية</div>
                  <div class="settings-desc">تصدير البيانات والصور</div>
                </div>
              </div>
              <button class="btn btn-primary btn-sm" id="backupBtn">
                <i class="fas fa-download"></i>
              </button>
            </div>
            <div class="settings-item">
              <div class="settings-label">
                <i class="fas fa-cloud-upload"></i>
                <div class="settings-text">
                  <div class="settings-name">استيراد</div>
                  <div class="settings-desc">استيراد البيانات من ملف</div>
                </div>
              </div>
              <button class="btn btn-primary btn-sm" id="importBtn">
                <i class="fas fa-upload"></i>
              </button>
            </div>
            <div class="settings-item">
              <div class="settings-label">
                <i class="fas fa-redo"></i>
                <div class="settings-text">
                  <div class="settings-name">إعادة تعيين</div>
                  <div class="settings-desc">حذف جميع البيانات</div>
                </div>
              </div>
              <button class="btn btn-danger btn-sm" id="resetBtn">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>

          <!-- System Info Section -->
          <div class="settings-section">
            <div class="settings-title">معلومات النظام</div>
            <div class="settings-item">
              <div class="settings-label">
                <i class="fas fa-info-circle"></i>
                <div class="settings-text">
                  <div class="settings-name">الإصدار</div>
                  <div class="settings-desc">v2.4.0 - نظام الحقول الديناميكي</div>
                </div>
              </div>
            </div>
            <div class="settings-item">
              <div class="settings-label">
                <i class="fas fa-database"></i>
                <div class="settings-text">
                  <div class="settings-name">مساحة التخزين</div>
                  <div class="settings-desc" id="storageInfo">حساب...</div>
                </div>
              </div>
            </div>
          </div>
          <!-- Store Information Section -->
          <div class="settings-section">
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0">معلومات المتجر</h5>
              </div>
              <div class="card-body">
                <div class="row g-3">
                  <div class="col-12 col-md-6">
                    <label class="form-label">اسم المتجر *</label>
                    <input type="text" class="form-control" id="storeName" placeholder="مثال: متجر النورس">
                  </div>
                  <div class="col-12 col-md-6">
                    <label class="form-label">النص الفرعي (Subtitle)</label>
                    <input type="text" class="form-control" id="storeSubtitleInput" placeholder="نص يظهر تحت اسم المتجر">
                    <small class="text-muted">سيظهر هذا النص تحت اسم المتجر في رأس التطبيق. إن تركته فارغاً سيعرض الهاتف/البريد/الموقع تلقائياً.</small>
                  </div>
                  <div class="col-12 col-md-6">
                    <label class="form-label">البريد الإلكتروني</label>
                    <input type="email" class="form-control" id="storeEmail" placeholder="store@example.com">
                  </div>
                  <div class="col-12 col-md-6">
                    <label class="form-label">رقم الهاتف</label>
                    <input type="text" class="form-control" id="storePhone" placeholder="مثال: +966501234567">
                  </div>
                  <div class="col-12 col-md-6">
                    <label class="form-label">الموقع الإلكتروني</label>
                    <input type="url" class="form-control" id="storeWebsite" placeholder="https://example.com">
                  </div>
                  <div class="col-12">
                    <label class="form-label">العنوان</label>
                    <input type="text" class="form-control" id="storeAddress" placeholder="المدينة، الشارع، رقم المبنى">
                  </div>
                  <div class="col-12 col-md-6">
                    <label class="form-label">شعار المتجر</label>
                    <input type="file" accept="image/*" class="form-control" id="storeLogoInput">
                    <small class="text-muted">اختياري. سيتم عرضه في رأس التطبيق.</small>
                    <div id="storeLogoPreview" class="mt-2"></div>
                  </div>
                  <div class="col-12 col-md-6 d-flex align-items-end justify-content-end">
                    <button class="btn btn-primary" id="saveStoreInfoBtn">
                      <i class="fas fa-save"></i> حفظ معلومات المتجر
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Product Details Modal -->
  <div class="modal" id="productModal">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">تفاصيل المنتج</h5>
        <button class="modal-close" id="closeProductModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body" id="productModalBody">
        <!-- Content will be dynamically inserted -->
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" id="editProductBtn">
          <i class="fas fa-edit"></i> تعديل
        </button>
        <button class="btn btn-danger" id="deleteProductBtn">
          <i class="fas fa-trash"></i> حذف
        </button>
        <button class="btn btn-outline-secondary" id="closeProductModalBtn">
          إغلاق
        </button>
      </div>
    </div>
  </div>

  <!-- Category Modal -->
  <div class="modal" id="categoryModal">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="categoryModalTitle">إضافة فئة جديدة</h5>
        <button class="modal-close" id="closeCategoryModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <form id="categoryForm">
          <div class="mb-3">
            <label class="form-label">اسم الفئة *</label>
            <input type="text" class="form-control" id="categoryName" required>
          </div>
          
          <div class="mb-3">
            <label class="form-label">الوصف</label>
            <textarea class="form-control" id="categoryDescription" rows="2"></textarea>
          </div>

          <button type="submit" class="btn btn-primary">
            <i class="fas fa-check"></i> حفظ الفئة
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- Field Editor Modal -->
  <div class="modal" id="fieldEditorModal">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="fieldModalTitle">إضافة حقل جديد</h5>
        <button class="modal-close" id="closeFieldModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div id="validationErrors" class="validation-errors" style="display: none;">
          <ul></ul>
        </div>

        <form id="fieldForm">
          <div class="mb-3">
            <label class="form-label">اسم الحقل (Label) *</label>
            <input type="text" class="form-control" id="fieldLabel" required>
            <small class="text-muted">الاسم الذي سيظهر للمستخدم</small>
          </div>
          
          <div class="mb-3">
            <label class="form-label">المفتاح (Key) *</label>
            <input type="text" class="form-control" id="fieldKey" required>
            <small class="text-muted">المفتاح الداخلي المستخدم في حفظ البيانات (بدون مسافات)</small>
          </div>
          
          <div class="mb-3">
            <label class="form-label">نوع الحقل *</label>
            <select class="form-select" id="fieldType" required>
              <option value="">اختر نوع الحقل</option>
              <option value="text">نص</option>
              <option value="number">رقم</option>
              <option value="textarea">نص طويل</option>
              <option value="select">قائمة منسدلة</option>
              <option value="radio">اختيار فردي</option>
              <option value="checkbox">اختيار متعدد</option>
              <option value="date">تاريخ</option>
              <option value="file">ملف</option>
            </select>
          </div>

          <!-- Options Section (for select, radio, checkbox) -->
          <div class="mb-3" id="fieldOptionsSection" style="display: none;">
            <label class="form-label">خيارات الحقل</label>
            <div class="d-flex justify-content-between align-items-center mb-2">
              <small class="text-muted">أضف الخيارات المتاحة</small>
              <button type="button" class="btn btn-sm btn-outline-primary" id="addFieldOptionBtn">
                <i class="fas fa-plus"></i> إضافة خيار
              </button>
            </div>
            <div id="fieldOptionsList">
              <!-- Options will be added here -->
            </div>
          </div>

          <!-- Additional Settings -->
          <div class="mb-3">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="fieldRequired">
              <label class="form-check-label">حقل مطلوب</label>
            </div>
          </div>
          
          <div class="mb-3">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="fieldAttribute">
              <label class="form-check-label">اعتبار كخاصية (يظهر في الجداول والبحث)</label>
            </div>
          </div>

          <!-- Field Preview -->
          <div id="fieldPreview" class="field-preview" style="display: none;">
            <div class="field-preview-title">معاينة الحقل</div>
            <div id="fieldPreviewContent">
              <!-- Preview will be generated here -->
            </div>
          </div>

          <button type="submit" class="btn btn-primary">
            <i class="fas fa-check"></i> حفظ الحقل
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- Barcode Search Modal -->
  <div class="modal" id="barcodeModal">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">بحث بالباركود</h5>
        <button class="modal-close" id="closeBarcodeModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">أدخل رقم الباركود يدويًا</label>
          <input type="text" class="form-control" id="manualBarcodeInput" placeholder="أدخل رقم الباركود">
          <button class="btn btn-primary w-100 mt-2" id="searchByBarcodeBtn">
            <i class="fas fa-search"></i> بحث
          </button>
        </div>
        
        <div class="mb-3">
          <label class="form-label">أو ارفع صورة الباركود</label>
          <input type="file" class="form-control" id="barcodeImageInput" accept="image/*">
          <button class="btn btn-outline-secondary w-100 mt-2" id="uploadBarcodeBtn">
            <i class="fas fa-upload"></i> رفع الصورة
          </button>
        </div>
        
        <div class="mb-3">
          <label class="form-label">أو استخدم الكاميرا لمسح الباركود</label>
          <div class="barcode-scanner" id="barcodeScanner">
            <video id="barcodeVideo" autoplay playsinline></video>
            <div class="barcode-scanner-overlay">
              <div class="barcode-scanner-frame"></div>
            </div>
          </div>
          <button class="btn btn-outline-primary w-100" id="startCameraBtn">
            <i class="fas fa-camera"></i> تشغيل الكاميرا
          </button>
          <button class="btn btn-outline-secondary w-100 mt-2 d-none" id="stopCameraBtn">
            <i class="fas fa-stop"></i> إيقاف الكاميرا
          </button>
        </div>
        
        <div id="barcodeResult" class="mt-3" style="display: none;">
          <!-- Barcode search results will appear here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div class="modal" id="confirmationModal">
    <div class="modal-content">
      <div class="modal-body">
        <div class="confirmation-dialog">
          <i class="fas fa-exclamation-triangle"></i>
          <h4 id="confirmationTitle">تأكيد الحذف</h4>
          <p id="confirmationMessage">هل أنت متأكد من أنك تريد حذف هذا المنتج؟ هذا الإجراء لا يمكن التراجع عنه.</p>
          <div class="d-flex justify-content-center gap-2">
            <button class="btn btn-danger" id="confirmActionBtn">نعم، احذف</button>
            <button class="btn btn-outline-secondary" id="cancelActionBtn">إلغاء</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- Hidden file input for import -->
  <input type="file" id="importFileInput" accept=".json" style="display: none;">
  <input type="file" id="importStructureFileInput" accept=".json" style="display: none;">

  <!-- JavaScript -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <script>
    /**************************************************************************
     * PUSHDARAH - Advanced Product Management System
     * Version 2.4.0 - Enhanced with Dynamic Form Structure System
     * Complete Functional Implementation with SLIDE CARDS DESIGN
     **************************************************************************/

    // ==================== GLOBAL VARIABLES ====================
    let currentPage = 'home';
    let products = [];
    let formStructure = {
      version: "2.4.0",
      lastUpdated: new Date().toISOString(),
      categories: {}
    };
    let currentProductId = null;
    let currentCategoryId = null;
    let editingProduct = false;
    let theme = localStorage.getItem('theme') || 'light';
    let calendarType = localStorage.getItem('calendarType') || 'gregorian';
    let baseCurrency = localStorage.getItem('baseCurrency') || 'SAR';
    let productViewMode = localStorage.getItem('productViewMode') || 'grid';
    let currentEditingCategory = null;
    let currentParentForCategory = null;
    let currentEditingField = null;
    let categoriesSortable = null;
    let fieldsSortable = null;

    const currencyOptions = {
      SAR: { code: 'SAR', name: 'ريال سعودي', flag: '🇸🇦', locale: 'ar-SA', minimumFractionDigits: 0 },
      USD: { code: 'USD', name: 'دولار أمريكي', flag: '🇺🇸', locale: 'en-US', minimumFractionDigits: 2 },
      YER: { code: 'YER', name: 'ريال يمني', flag: '🇾🇪', locale: 'ar-YE', minimumFractionDigits: 0 }
    };
    
    let deletedNames = new Set(JSON.parse(localStorage.getItem('deletedNames') || '[]'));

    // ==================== INITIALIZATION ====================
    document.addEventListener('DOMContentLoaded', () => {
      initializeApp();
      setupEventListeners();
      loadData();
      applyTheme(theme);
      applyCalendarType(calendarType, false);
      applyBaseCurrency(baseCurrency, false);
      applyProductViewMode(productViewMode);
      updateStorageInfo();
      loadStoreInfo();
    });

    // ==================== APP INITIALIZATION ====================
    function initializeApp() {
      const savedProducts = localStorage.getItem('products');
      const savedFormStructure = localStorage.getItem('formStructure');
      
      if (savedProducts) {
        products = JSON.parse(savedProducts);
      } else {
        products = getSampleProducts();
        saveData();
      }
      
      if (savedFormStructure) {
        formStructure = JSON.parse(savedFormStructure);
        migrateFromOldStructure();
      } else {
        formStructure = getSampleFormStructure();
        saveData();
      }
    }

    // ==================== EVENT LISTENERS ====================
    function setupEventListeners() {
      // Toolbar navigation
      document.querySelectorAll('.toolbar-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const page = btn.getAttribute('data-page');
          navigateToPage(page);
        });
      });

      // Theme toggles
      document.getElementById('desktopThemeToggle').addEventListener('click', toggleTheme);
      document.getElementById('settingsThemeSwitch').addEventListener('click', toggleTheme);

      // Quick actions
      document.getElementById('quickAddProduct').addEventListener('click', () => navigateToPage('add'));
      document.getElementById('quickViewProducts').addEventListener('click', () => navigateToPage('products'));
      document.getElementById('quickManageCategories').addEventListener('click', () => navigateToPage('categories'));
      document.getElementById('quickBackup').addEventListener('click', backupData);

      // Product form
      document.getElementById('productForm').addEventListener('submit', handleProductSubmit);
      document.getElementById('resetForm').addEventListener('click', resetProductForm);
      document.getElementById('productImage').addEventListener('change', handleImagePreview);

      // Form Structure Editor
      document.getElementById('addCategoryBtn').addEventListener('click', openCategoryModal);
      document.getElementById('addFieldBtn').addEventListener('click', openFieldEditorModal);
      document.getElementById('importStructureBtn').addEventListener('click', () => {
        document.getElementById('importStructureFileInput').click();
      });
      document.getElementById('exportStructureBtn').addEventListener('click', exportFormStructure);
      document.getElementById('importStructureFileInput').addEventListener('change', handleStructureImport);

      // Category form
      document.getElementById('categoryForm').addEventListener('submit', handleCategorySubmit);

      // Field form
      document.getElementById('fieldForm').addEventListener('submit', handleFieldSubmit);
      document.getElementById('fieldType').addEventListener('change', handleFieldTypeChange);
      document.getElementById('addFieldOptionBtn').addEventListener('click', addFieldOption);
      document.getElementById('fieldLabel').addEventListener('input', updateFieldKey);
      document.getElementById('fieldLabel').addEventListener('input', updateFieldPreview);
      document.getElementById('fieldType').addEventListener('change', updateFieldPreview);

      // Product form dynamic updates
      document.getElementById('productMainCategory').addEventListener('change', function() {
        renderDynamicFields(this.value);
      });
      document.getElementById('productUnit').addEventListener('change', updatePriceAndQuantityFields);

      // Search
      document.getElementById('productSearch').addEventListener('input', handleProductSearch);
      document.getElementById('desktopSearchBtn').addEventListener('click', () => {
        navigateToPage('products');
        setTimeout(() => document.getElementById('productSearch').focus(), 300);
      });

      // Filters
      document.getElementById('categoryFilter').addEventListener('change', renderProducts);
      document.getElementById('priceFilter').addEventListener('change', renderProducts);
      document.getElementById('sortBy').addEventListener('change', renderProducts);

      // Settings
      document.getElementById('backupBtn').addEventListener('click', backupData);
      document.getElementById('importBtn').addEventListener('click', () => {
        document.getElementById('importFileInput').click();
      });
      document.getElementById('importFileInput').addEventListener('change', handleImport);
      document.getElementById('resetBtn').addEventListener('click', resetAllData);
      document.getElementById('themeColor').addEventListener('change', handleThemeColorChange);
      
      document.getElementById('baseCurrencySelect').addEventListener('change', handleBaseCurrencyChange);
      
      // Calendar type change listener
      document.getElementById('calendarType').addEventListener('change', handleCalendarTypeChange);

      // View controls
      document.getElementById('gridViewBtn').addEventListener('click', () => applyProductViewMode('grid'));
      document.getElementById('listViewBtn').addEventListener('click', () => applyProductViewMode('list'));

      // Barcode search
      document.getElementById('barcodeSearchBtn').addEventListener('click', openBarcodeModal);
      document.getElementById('closeBarcodeModal').addEventListener('click', closeBarcodeModal);
      document.getElementById('searchByBarcodeBtn').addEventListener('click', searchByBarcode);
      document.getElementById('uploadBarcodeBtn').addEventListener('click', uploadBarcodeImage);
      document.getElementById('startCameraBtn').addEventListener('click', startBarcodeScanner);
      document.getElementById('stopCameraBtn').addEventListener('click', stopBarcodeScanner);

      // Modals
      document.getElementById('closeProductModal').addEventListener('click', closeProductModal);
      document.getElementById('closeProductModalBtn').addEventListener('click', closeProductModal);
      document.getElementById('closeCategoryModal').addEventListener('click', closeCategoryModal);
      document.getElementById('closeFieldModal').addEventListener('click', closeFieldEditorModal);
      document.getElementById('editProductBtn').addEventListener('click', editCurrentProduct);
      document.getElementById('deleteProductBtn').addEventListener('click', confirmDeleteProduct);

      // Confirmation modal
      // `confirmActionBtn` action is assigned dynamically by `openConfirmationModal`
      document.getElementById('cancelActionBtn').addEventListener('click', closeConfirmationModal);

      // Close modals when clicking outside
      document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            modal.classList.remove('active');
          }
        });
      });

      // Keyboard shortcuts
      document.addEventListener('keydown', (e) => {
        if (e.ctrlKey && e.key === 'k') {
          e.preventDefault();
          navigateToPage('products');
          setTimeout(() => document.getElementById('productSearch').focus(), 300);
        }
        if (e.key === 'Escape') {
          closeAllModals();
        }
      });

      // Store info
      document.getElementById('saveStoreInfoBtn').addEventListener('click', saveStoreInfo);
      document.getElementById('storeLogoInput').addEventListener('change', handleStoreLogoChange);
    }

    // ==================== NAVIGATION ====================
    function navigateToPage(page) {
      document.querySelectorAll('.toolbar-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.getAttribute('data-page') === page) {
          btn.classList.add('active');
        }
      });

      document.querySelectorAll('.page').forEach(p => {
        p.classList.remove('active');
      });

      document.getElementById(`${page}Page`).classList.add('active');
      currentPage = page;

      switch (page) {
        case 'home':
          updateDashboard();
          break;
        case 'products':
          renderProducts();
          updateCategoryFilter();
          break;
        case 'categories':
          renderFormStructureEditor();
          break;
        case 'add':
          updateMainCategoryOptions();
          if (!editingProduct) {
            resetProductForm();
          }
          break;
        case 'settings':
          updateStorageInfo();
          break;
      }
    }

    // ==================== SLIDE CARDS DESIGN FOR CATEGORIES ====================
    function renderFormStructureEditor() {
      renderCategoriesList();
      initializeSortable();
    }

    function renderCategoriesList() {
      const container = document.getElementById('categoriesListItems');
      const rawCategories = Object.keys(formStructure.categories);

      if (rawCategories.length === 0) {
        container.innerHTML = `
          <div class="empty-state" style="padding: 2rem 1rem;">
            <i class="fas fa-folder"></i>
            <h3>لا توجد فئات</h3>
            <p>ابدأ بإضافة فئة جديدة</p>
          </div>
        `;
        return;
      }

      let html = `
        <div class="categories-slider-container">
          <div class="categories-slider" id="categoriesSlider">
      `;

      rawCategories.forEach(categoryName => {
        const fields = formStructure.categories[categoryName] || [];
        const isActive = currentEditingCategory === categoryName;
        
        const subcats = rawCategories.filter(c => c.startsWith(categoryName + ' > ')).map(c => c.split(' > ')[1]);
        
        const categoryIcon = getCategoryIcon(categoryName);
        
        html += `
          <div class="slide-card ${isActive ? 'active' : ''} ${window.innerWidth < 576 ? 'compact' : ''}" 
                data-category="${categoryName}" 
                onclick="selectCategory('${categoryName}')">
            <div class="slide-card-header">
              <div class="slide-card-icon">
                <i class="${categoryIcon}"></i>
              </div>
              <div class="slide-card-actions">
                <button class="btn btn-xs btn-outline-primary" onclick="event.stopPropagation(); editCategory('${categoryName}')" title="تعديل الفئة">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-xs btn-outline-danger" onclick="event.stopPropagation(); deleteCategory('${categoryName}')" title="حذف الفئة">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
            
            <div class="slide-card-content">
              <div class="slide-card-title">${categoryName}</div>
              
              <div class="slide-card-stats">
                <div class="slide-card-stat">
                  <div class="slide-stat-value">${fields.length}</div>
                  <div class="slide-stat-label">حقول</div>
                </div>
                <div class="slide-card-stat">
                  <div class="slide-stat-value">${subcats.length}</div>
                  <div class="slide-stat-label">فئات فرعية</div>
                </div>
              </div>
              
              <div class="slide-card-subcategories">
                <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.5rem;">الفئات الفرعية:</div>
                <div class="slide-subcategories-list">
                  ${subcats.length > 0 ? 
                    subcats.map(sub => `
                      <div class="slide-subcategory-tag" onclick="event.stopPropagation()">
                        <span>${sub}</span>
                        <div class="actions">
                          <button class="btn btn-xxs btn-outline-primary" onclick="editSubcategory('${categoryName}', '${sub}')" title="تعديل">
                            <i class="fas fa-edit"></i>
                          </button>
                          <button class="btn btn-xxs btn-outline-danger" onclick="deleteSubcategory('${categoryName}', '${sub}')" title="حذف">
                            <i class="fas fa-trash"></i>
                          </button>
                        </div>
                      </div>
                    `).join('') : 
                    '<div class="slide-no-subcategories">لا توجد فئات فرعية</div>'
                  }
                </div>
              </div>
            </div>
            
            <div class="slide-card-footer">
              <div class="slide-card-date">آخر تحديث: ${formatDate(formStructure.lastUpdated)}</div>
            </div>
          </div>
        `;
      });

      html += `
          </div>
          <button class="slider-nav prev" onclick="scrollSlider(-1)">
            <i class="fas fa-chevron-right"></i>
          </button>
          <button class="slider-nav next" onclick="scrollSlider(1)">
            <i class="fas fa-chevron-left"></i>
          </button>
        </div>
      `;
      
      container.innerHTML = html;
      updateSliderNavigation();
    }

    // Initialize Sortable for categories slider (non-intrusive)
    function initializeSortable() {
      const slider = document.getElementById('categoriesSlider');
      if (!slider) return;

      if (categoriesSortable) {
        try { categoriesSortable.destroy(); } catch (e) { /* ignore */ }
      }

      // Configure Sortable to be non-intrusive: horizontal, require a short delay
      // before starting a drag (so simple clicks/select still work), and avoid
      // full re-render on end to preserve user scroll/selection state.
      categoriesSortable = new Sortable(slider, {
        animation: 150,
        draggable: '.slide-card',
        direction: 'horizontal',
        delay: 180, // require a short press/hold before drag starts
        delayOnTouchOnly: true,
        touchStartThreshold: 5,
        onStart: function(evt) {
          evt.item.classList.add('dragging');
        },
        onEnd: function(evt) {
          try { evt.item.classList.remove('dragging'); } catch (e) {}

          // Rebuild categories order based on DOM, but do NOT re-render the whole slider
          const cards = Array.from(slider.querySelectorAll('.slide-card'));
          const newOrder = cards.map(c => c.getAttribute('data-category'));
          const newCategories = {};
          newOrder.forEach(name => {
            if (formStructure.categories.hasOwnProperty(name)) {
              newCategories[name] = formStructure.categories[name];
            }
          });
          // Append any missing categories (shouldn't normally happen)
          Object.keys(formStructure.categories).forEach(name => {
            if (!newCategories.hasOwnProperty(name)) {
              newCategories[name] = formStructure.categories[name];
            }
          });

          formStructure.categories = newCategories;
          formStructure.lastUpdated = new Date().toISOString();
          saveData();

          // Update navigation visibility and keep current DOM (no full re-render)
          updateSliderNavigation();
        }
      });
    }

    function scrollSlider(direction) {
      const slider = document.getElementById('categoriesSlider');
      const scrollAmount = 320;
      slider.scrollBy({
        left: direction * scrollAmount,
        behavior: 'smooth'
      });
      
      setTimeout(updateSliderNavigation, 300);
    }

    function updateSliderNavigation() {
      const slider = document.getElementById('categoriesSlider');
      if (!slider) return;
      
      const prevBtn = document.querySelector('.slider-nav.prev');
      const nextBtn = document.querySelector('.slider-nav.next');
      
      if (slider.scrollLeft <= 10) {
        prevBtn.classList.add('hidden');
      } else {
        prevBtn.classList.remove('hidden');
      }
      
      if (slider.scrollLeft + slider.clientWidth >= slider.scrollWidth - 10) {
        nextBtn.classList.add('hidden');
      } else {
        nextBtn.classList.remove('hidden');
      }
    }

    function getCategoryIcon(categoryName) {
      const iconMap = {
        'إلكترونيات': 'fas fa-laptop',
        'ملابس': 'fas fa-tshirt',
        'أثاث': 'fas fa-couch',
        'كتب': 'fas fa-book',
        'هواتف': 'fas fa-mobile-alt',
        'أجهزة': 'fas fa-tablet-alt',
        'ألعاب': 'fas fa-gamepad',
        'رياضة': 'fas fa-running',
        'مطبخ': 'fas fa-utensils',
        'سيارات': 'fas fa-car',
        'أدوات': 'fas fa-tools',
        'مجوهرات': 'fas fa-gem',
        'صحة': 'fas fa-heartbeat',
        'جمال': 'fas fa-spa'
      };

      for (const [key, icon] of Object.entries(iconMap)) {
        if (categoryName.includes(key)) {
          return icon;
        }
      }

      return 'fas fa-folder';
    }

    function selectCategory(categoryName) {
      currentEditingCategory = categoryName;
      
      document.querySelectorAll('.slide-card').forEach(card => {
        card.classList.remove('active');
      });
      
      const selectedCard = document.querySelector(`[data-category="${categoryName}"]`);
      if (selectedCard) {
        selectedCard.classList.add('active');
      }
      
      document.getElementById('addFieldBtn').disabled = false;
      document.getElementById('selectedCategoryTitle').textContent = `حقول ${categoryName}`;
      renderFieldsList(categoryName);
      updateFormPreview(categoryName);
    }

    // ==================== REMAINING FUNCTIONS ====================
    // [All other functions remain the same as in the original working version]
    // Including all the functionality for products, forms, modals, etc.

    // ==================== THEME MANAGEMENT ====================
    function applyTheme(newTheme) {
      theme = newTheme;
      if (theme === 'dark') {
        document.body.classList.add('dark-mode');
        document.getElementById('desktopThemeIcon').className = 'fas fa-sun';
        document.getElementById('settingsThemeSwitch').classList.add('active');
      } else {
        document.body.classList.remove('dark-mode');
        document.getElementById('desktopThemeIcon').className = 'fas fa-moon';
        document.getElementById('settingsThemeSwitch').classList.remove('active');
      }
      localStorage.setItem('theme', theme);
    }

    function toggleTheme() {
      const newTheme = theme === 'light' ? 'dark' : 'light';
      applyTheme(newTheme);
      showToast(`تم تفعيل الوضع ${newTheme === 'dark' ? 'الداكن' : 'الفاتح'}`, 'success');
    }

    function handleThemeColorChange(e) {
      const color = e.target.value;
      const root = document.documentElement;
      
      switch (color) {
        case 'green':
          root.style.setProperty('--accent', '#10b981');
          root.style.setProperty('--accent-hover', '#059669');
          root.style.setProperty('--accent-light', '#d1fae5');
          break;
        case 'purple':
          root.style.setProperty('--accent', '#8b5cf6');
          root.style.setProperty('--accent-hover', '#7c3aed');
          root.style.setProperty('--accent-light', '#ede9fe');
          break;
        case 'red':
          root.style.setProperty('--accent', '#ef4444');
          root.style.setProperty('--accent-hover', '#dc2626');
          root.style.setProperty('--accent-light', '#fee2e2');
          break;
        default:
          root.style.setProperty('--accent', '#3b82f6');
          root.style.setProperty('--accent-hover', '#2563eb');
          root.style.setProperty('--accent-light', '#dbeafe');
      }
      
      localStorage.setItem('themeColor', color);
      showToast(`تم تغيير لون السمة إلى ${color}`, 'success');
    }

    // ==================== PRODUCT VIEW MODE ====================
    function applyProductViewMode(mode) {
      productViewMode = mode;
      localStorage.setItem('productViewMode', mode);
      
      const gridViewBtn = document.getElementById('gridViewBtn');
      const listViewBtn = document.getElementById('listViewBtn');
      const productsContainer = document.getElementById('productsContainer');
      
      if (mode === 'grid') {
        gridViewBtn.classList.add('active');
        listViewBtn.classList.remove('active');
        if (productsContainer) {
          productsContainer.classList.remove('list-view');
        }
      } else {
        gridViewBtn.classList.remove('active');
        listViewBtn.classList.add('active');
        if (productsContainer) {
          productsContainer.classList.add('list-view');
        }
      }
      
      if (currentPage === 'products') {
        renderProducts();
      }
    }

    // ==================== CALENDAR MANAGEMENT ====================
    function handleCalendarTypeChange(e) {
      const newType = e.target.value;
      applyCalendarType(newType, true); 
    }

    function applyCalendarType(newType, showToastMessage = true) {
      calendarType = newType;
      localStorage.setItem('calendarType', calendarType);
      document.getElementById('calendarType').value = calendarType;
      refreshAllDates();
      
      if (showToastMessage) {
        showToast(`تم تغيير التقويم إلى ${calendarType === 'hijri' ? 'الهجري' : 'الميلادي'}`, 'success');
      }
    }

    function formatDate(dateString) {
      if (!dateString) return '';
      const date = new Date(dateString);
      
      if (calendarType === 'hijri') {
        try {
          const hijriDate = new HijriDate(date);
          return hijriDate.format('dd/mm/yyyy');
        } catch (e) {
          return date.toLocaleDateString('ar-SA');
        }
      } else {
        return date.toLocaleDateString('ar-SA');
      }
    }

    function refreshAllDates() {
      if (currentPage === 'home') {
        updateRecentActivities();
      }
      
      if (document.getElementById('productModal').classList.contains('active') && currentProductId) {
        const product = products.find(p => p.id === currentProductId);
        if (product) {
          const allPs = document.querySelectorAll('#productModalBody p');
          for(let p of allPs) {
              if(p.innerHTML.includes('<strong>تاريخ الإضافة:</strong>')) {
                  p.innerHTML = `<strong>تاريخ الإضافة:</strong> ${formatDate(product.createdAt)}`;
                  break;
              }
          }
        }
      }
    }

    // ==================== DATA MANAGEMENT ====================
    function saveData() {
      localStorage.setItem('products', JSON.stringify(products));
      localStorage.setItem('formStructure', JSON.stringify(formStructure));
      localStorage.setItem('baseCurrency', baseCurrency);
      localStorage.setItem('deletedNames', JSON.stringify(Array.from(deletedNames)));
      updateStorageInfo();
    }

    function loadData() {
      updateDashboard();
      updateCategoryFilter();
      updateMainCategoryOptions();
    }

    function backupData() {
      const data = {
        products: products,
        formStructure: formStructure,
        deletedNames: Array.from(deletedNames),
        baseCurrency: baseCurrency,
        exportDate: new Date().toISOString(),
        version: '2.4.0'
      };
      
      const dataStr = JSON.stringify(data, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      
      const link = document.createElement('a');
      link.href = URL.createObjectURL(dataBlob);
      link.download = `pusdarah-backup-${new Date().toISOString().slice(0, 10)}.json`;
      link.click();
      
      showToast('تم إنشاء نسخة احتياطية بنجاح', 'success');
    }

    function handleImport(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          const data = JSON.parse(event.target.result);
          
          if (data.products && data.formStructure) {
            openConfirmationModal(
              'تأكيد استيراد البيانات',
              'هل تريد استبدال جميع البيانات الحالية بالبيانات المستوردة؟',
              function() {
                products = data.products || [];
                formStructure = data.formStructure || getSampleFormStructure();
                deletedNames = new Set(data.deletedNames || []);
                baseCurrency = data.baseCurrency || 'SAR';
                saveData();
                loadData();
                applyBaseCurrency(baseCurrency, false);
                showToast('تم استيراد البيانات بنجاح', 'success');
                closeConfirmationModal();
              }
            );
          } else {
            showToast('ملف الاستيراد غير صالح', 'error');
          }
        } catch (error) {
          showToast('خطأ في قراءة الملف المستورد', 'error');
        }
      };
      reader.readAsText(file);
      e.target.value = '';
    }

    function resetAllData() {
      openConfirmationModal(
        'تأكيد حذف البيانات',
        'هل أنت متأكد من حذف جميع البيانات؟ هذا الإجراء لا يمكن التراجع عنه.',
        function() {
          products = [];
          formStructure = getSampleFormStructure();
          deletedNames.clear();
          baseCurrency = 'SAR';
          saveData();
          loadData();
          applyBaseCurrency('SAR', false);
          showToast('تم حذف جميع البيانات', 'warning');
          closeConfirmationModal();
        }
      );
    }

    function updateStorageInfo() {
      const productsSize = JSON.stringify(products).length;
      const formStructureSize = JSON.stringify(formStructure).length;
      const deletedNamesSize = JSON.stringify(Array.from(deletedNames)).length;
      const totalSize = productsSize + formStructureSize + deletedNamesSize;
      const sizeInKB = (totalSize / 1024).toFixed(2);
      document.getElementById('storageInfo').textContent = `${sizeInKB} KB`;
    }

    // ==================== DASHBOARD ====================
    function updateDashboard() {
      document.getElementById('totalProducts').textContent = products.length;
      document.getElementById('totalCategories').textContent = Object.keys(formStructure.categories).length;
      
      const totalValue = products.reduce((sum, product) => sum + (product.price * (product.quantity || 0)), 0);
      document.getElementById('totalValue').textContent = formatPriceWithCurrency(totalValue);
      
      const lowStock = products.filter(product => (product.quantity || 0) < 5).length;
      document.getElementById('lowStock').textContent = lowStock;
      
      updateRecentActivities();
    }

    function updateRecentActivities() {
      const activitiesContainer = document.getElementById('recentActivities');
      
      if (products.length === 0) {
        activitiesContainer.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-clock"></i>
            <h3>لا توجد أنشطة حديثة</h3>
            <p>ستظهر هنا آخر العمليات التي قمت بها</p>
          </div>
        `;
        return;
      }
      
      const recentProducts = [...products]
        .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
        .slice(0, 5);
      
      let activitiesHTML = '<div class="list-group">';
      recentProducts.forEach(product => {
        const date = formatDate(product.createdAt);
        activitiesHTML += `
          <div class="list-group-item">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="mb-1">${product.name}</h6>
                <small class="text-muted">تمت الإضافة في ${date}</small>
              </div>
              <span class="badge bg-primary">${formatPriceWithCurrency(product.price)}</span>
            </div>
          </div>
        `;
      });
      activitiesHTML += '</div>';
      
      activitiesContainer.innerHTML = activitiesHTML;
    }

    // ==================== PRODUCTS ====================
    function renderProducts() {
      const container = document.getElementById('productsContainer');
      
      if (products.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-box"></i>
            <h3>لا توجد منتجات</h3>
            <p>ابدأ بإضافة منتج جديد</p>
            <button class="btn btn-primary mt-3" onclick="navigateToPage('add')">
              <i class="fas fa-plus"></i> إضافة منتج
            </button>
          </div>
        `;
        return;
      }
      
      let filteredProducts = [...products];
      
      const categoryFilter = document.getElementById('categoryFilter').value;
      if (categoryFilter) {
        filteredProducts = filteredProducts.filter(p => p.mainCategoryId === categoryFilter);
      }
      
      const priceFilter = document.getElementById('priceFilter').value;
      if (priceFilter) {
        if (priceFilter === '0-100') {
          filteredProducts = filteredProducts.filter(p => p.price < 100);
        } else if (priceFilter === '100-500') {
          filteredProducts = filteredProducts.filter(p => p.price >= 100 && p.price < 500);
        } else if (priceFilter === '500-1000') {
          filteredProducts = filteredProducts.filter(p => p.price >= 500 && p.price < 1000);
        } else if (priceFilter === '1000+') {
          filteredProducts = filteredProducts.filter(p => p.price >= 1000);
        }
      }
      
      const sortBy = document.getElementById('sortBy').value;
      if (sortBy === 'name') {
        filteredProducts.sort((a, b) => a.name.localeCompare(b.name));
      } else if (sortBy === 'price-asc') {
        filteredProducts.sort((a, b) => a.price - b.price);
      } else if (sortBy === 'price-desc') {
        filteredProducts.sort((a, b) => b.price - a.price);
      } else if (sortBy === 'date') {
        filteredProducts.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
      }
      
      let productsHTML = `<div class="product-grid ${productViewMode === 'list' ? 'list-view' : ''}">`;
      filteredProducts.forEach(product => {
        const categoryName = product.mainCategoryId || 'غير مصنف';
        
        productsHTML += `
          <div class="product-card ${productViewMode === 'list' ? 'list-view' : ''}" onclick="openProductModal('${product.id}')">
            <img src="${product.image || getDefaultImage()}" alt="${product.name}" class="product-image">
            <div class="product-details">
              <h5 class="product-name">${product.name}</h5>
              <div class="product-price">${formatPriceWithCurrency(product.price)} / ${product.unit || 'قطعة'}</div>
              <div class="product-category">${categoryName}</div>
              <div class="product-actions">
                <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); openProductModal('${product.id}')">
                  <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-sm btn-outline-secondary" onclick="event.stopPropagation(); editProduct('${product.id}')">
                  <i class="fas fa-edit"></i>
                </button>
              </div>
            </div>
          </div>
        `;
      });
      productsHTML += '</div>';
      
      container.innerHTML = productsHTML;
    }

    function handleProductSearch(e) {
      const searchTerm = e.target.value.toLowerCase();
      
      if (!searchTerm) {
        renderProducts();
        return;
      }
      
      const container = document.getElementById('productsContainer');
      const filteredProducts = products.filter(product => 
        product.name.toLowerCase().includes(searchTerm) ||
        (product.sku && product.sku.toLowerCase().includes(searchTerm)) ||
        (product.description && product.description.toLowerCase().includes(searchTerm)) ||
        (product.barcode && product.barcode.toLowerCase().includes(searchTerm))
      );
      
      if (filteredProducts.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-search"></i>
            <h3>لا توجد نتائج</h3>
            <p>لم يتم العثور على منتجات تطابق "${e.target.value}"</p>
          </div>
        `;
        return;
      }
      
      let productsHTML = `<div class="product-grid ${productViewMode === 'list' ? 'list-view' : ''}">`;
      filteredProducts.forEach(product => {
        const categoryName = product.mainCategoryId || 'غير مصنف';
        
        productsHTML += `
          <div class="product-card ${productViewMode === 'list' ? 'list-view' : ''}" onclick="openProductModal('${product.id}')">
            <img src="${product.image || getDefaultImage()}" alt="${product.name}" class="product-image">
            <div class="product-details">
              <h5 class="product-name">${product.name}</h5>
              <div class="product-price">${formatPriceWithCurrency(product.price)} / ${product.unit || 'قطعة'}</div>
              <div class="product-category">${categoryName}</div>
              <div class="product-actions">
                <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); openProductModal('${product.id}')">
                  <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-sm btn-outline-secondary" onclick="event.stopPropagation(); editProduct('${product.id}')">
                  <i class="fas fa-edit"></i>
                </button>
              </div>
            </div>
          </div>
        `;
      });
      productsHTML += '</div>';
      
      container.innerHTML = productsHTML;
    }

    function updateCategoryFilter() {
      const categoryFilter = document.getElementById('categoryFilter');
      categoryFilter.innerHTML = '<option value="">جميع الفئات</option>';
      
      Object.keys(formStructure.categories).forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        categoryFilter.appendChild(option);
      });
    }

    // ==================== PRODUCT FORM ====================
    function handleProductSubmit(e) {
      e.preventDefault();
      
      const name = document.getElementById('productName').value.trim();
      const sku = document.getElementById('productSku').value.trim();
      const barcode = document.getElementById('productBarcode').value.trim();
      const mainCategoryId = document.getElementById('productMainCategory').value;
      const unit = document.getElementById('productUnit').value;
      const price = parseFloat(document.getElementById('productPrice').value);
      const quantity = parseInt(document.getElementById('productQuantity').value) || 0;
      const description = document.getElementById('productDescription').value.trim();
      const imageInput = document.getElementById('productImage');
      
      if (!name || !price || !mainCategoryId) {
        showToast('يرجى ملء الحقول المطلوبة (الاسم، السعر، الفئة الرئيسية)', 'warning');
        return;
      }
      
      const dynamicFields = {};
      const dynamicFieldElements = document.querySelectorAll('#dynamicFieldsContainer input, #dynamicFieldsContainer textarea, #dynamicFieldsContainer select');
      dynamicFieldElements.forEach(element => {
        const fieldName = element.getAttribute('data-field-name');
        if (fieldName) {
          if (element.type === 'checkbox') {
            if (!dynamicFields[fieldName]) {
              dynamicFields[fieldName] = [];
            }
            if (element.checked) {
              dynamicFields[fieldName].push(element.value);
            }
          } else if (element.type === 'radio') {
            if (element.checked) {
              dynamicFields[fieldName] = element.value;
            }
          } else {
            dynamicFields[fieldName] = element.value;
          }
        }
      });
      
      if (imageInput.files && imageInput.files[0]) {
        const reader = new FileReader();
        reader.onload = (event) => {
          saveProduct({
            name,
            sku,
            barcode,
            mainCategoryId,
            unit,
            price,
            quantity,
            description,
            image: event.target.result,
            dynamicFields
          });
        };
        reader.readAsDataURL(imageInput.files[0]);
      } else {
        let image = null;
        if (editingProduct && currentProductId) {
          const existingProduct = products.find(p => p.id === currentProductId);
          image = existingProduct?.image || null;
        }
        
        saveProduct({
          name,
          sku,
          barcode,
          mainCategoryId,
          unit,
          price,
          quantity,
          description,
          image,
          dynamicFields
        });
      }
    }

    function saveProduct(productData) {
      if (editingProduct && currentProductId) {
        const index = products.findIndex(p => p.id === currentProductId);
        if (index !== -1) {
          products[index] = {
            ...products[index],
            ...productData,
            updatedAt: new Date().toISOString()
          };
          showToast('تم تحديث المنتج بنجاح', 'success');
        }
      } else {
        const newProduct = {
          id: generateId(),
          ...productData,
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString()
        };
        products.push(newProduct);
        showToast('تم إضافة المنتج بنجاح', 'success');
      }
      
      saveData();
      resetProductForm();
      navigateToPage('products');
    }

    function resetProductForm() {
      document.getElementById('productForm').reset();
      document.getElementById('imagePreview').innerHTML = '';
      document.getElementById('dynamicFieldsContainer').innerHTML = '';
      editingProduct = false;
      currentProductId = null;
      document.getElementById('addProductTitle').textContent = 'إضافة منتج جديد';
      document.getElementById('submitProductBtn').innerHTML = '<i class="fas fa-check"></i> حفظ المنتج';
      document.getElementById('productUnit').value = 'piece';
      updatePriceAndQuantityFields();
    }

    function updatePriceAndQuantityFields() {
      if (currentPage !== 'add') return;
      const unit = document.getElementById('productUnit').value;
      const priceLabel = document.getElementById('priceLabel');
      const quantityLabel = document.getElementById('quantityLabel');
      
      if (!priceLabel || !quantityLabel) return;
      
      if (unit === 'piece') {
        priceLabel.textContent = 'السعر *';
        quantityLabel.textContent = 'الكمية';
      } else if (unit === 'meter') {
        priceLabel.textContent = 'السعر للمتر *';
        quantityLabel.textContent = 'الطول (متر)';
      } else if (unit === 'roll') {
        priceLabel.textContent = 'السعر للفة *';
        quantityLabel.textContent = 'عدد اللفات';
      } else if (unit === 'kg') {
        priceLabel.textContent = 'السعر للكيلو *';
        quantityLabel.textContent = 'الوزن (كجم)';
      }
    }

    function handleImagePreview(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = (event) => {
        const preview = document.getElementById('imagePreview');
        preview.innerHTML = `
          <img src="${event.target.result}" alt="Preview" style="max-width: 100%; max-height: 200px; border-radius: 8px;">
        `;
      };
      reader.readAsDataURL(file);
    }

    function editProduct(productId) {
      const product = products.find(p => p.id === productId);
      if (!product) return;
      
      currentProductId = productId;
      editingProduct = true;
      document.getElementById('addProductTitle').textContent = 'تعديل المنتج';
      document.getElementById('submitProductBtn').innerHTML = '<i class="fas fa-check"></i> تحديث المنتج';
      
      document.getElementById('productName').value = product.name;
      document.getElementById('productSku').value = product.sku || '';
      document.getElementById('productBarcode').value = product.barcode || '';
      document.getElementById('productMainCategory').value = product.mainCategoryId || '';
      document.getElementById('productUnit').value = product.unit || 'piece';
      document.getElementById('productPrice').value = product.price;
      document.getElementById('productQuantity').value = product.quantity || 0;
      document.getElementById('productDescription').value = product.description || '';
      
      if (product.image) {
        document.getElementById('imagePreview').innerHTML = `
          <img src="${product.image}" alt="Preview" style="max-width: 100%; max-height: 200px; border-radius: 8px;">
        `;
      }
      
      updatePriceAndQuantityFields();
      renderDynamicFields(product.mainCategoryId);
      
      if (product.dynamicFields) {
        Object.entries(product.dynamicFields).forEach(([key, value]) => {
          if (Array.isArray(value)) {
            value.forEach(val => {
              const element = document.querySelector(`[data-field-name="${key}"][value="${val}"]`);
              if (element) {
                element.checked = true;
              }
            });
          } else {
            const element = document.querySelector(`[data-field-name="${key}"]`);
            if (element) {
              if (element.type === 'radio') {
                const radioElement = document.querySelector(`[data-field-name="${key}"][value="${value}"]`);
                if (radioElement) {
                  radioElement.checked = true;
                }
              } else {
                element.value = value;
              }
            }
          }
        });
      }
      
      navigateToPage('add');
    }

    function updateMainCategoryOptions() {
      const mainCategorySelect = document.getElementById('productMainCategory');
      mainCategorySelect.innerHTML = '<option value="">اختر الفئة الرئيسية</option>';
      
      Object.keys(formStructure.categories).forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        mainCategorySelect.appendChild(option);
      });
    }

    function renderDynamicFields(categoryName) {
      const container = document.getElementById('dynamicFieldsContainer');
      container.innerHTML = '';
      
      if (!categoryName) return;
      
      const fields = formStructure.categories[categoryName] || [];
      
      if (fields.length === 0) return;
      
      let fieldsHTML = '<h6 class="mb-3">الحقول المخصصة</h6>';
      
      fields.forEach(field => {
        const required = field.required ? ' *' : '';
        
        switch (field.type) {
          case 'text':
            fieldsHTML += `
              <div class="mb-3">
                <label class="form-label">${field.label}${required}</label>
                <input type="text" class="form-control" data-field-name="${field.name}" placeholder="أدخل ${field.label}">
              </div>
            `;
            break;
          case 'number':
            fieldsHTML += `
              <div class="mb-3">
                <label class="form-label">${field.label}${required}</label>
                <input type="number" class="form-control" data-field-name="${field.name}" placeholder="أدخل ${field.label}">
              </div>
            `;
            break;
          case 'textarea':
            fieldsHTML += `
              <div class="mb-3">
                <label class="form-label">${field.label}${required}</label>
                <textarea class="form-control" data-field-name="${field.name}" placeholder="أدخل ${field.label}" rows="3"></textarea>
              </div>
            `;
            break;
          case 'select':
            fieldsHTML += `
              <div class="mb-3">
                <label class="form-label">${field.label}${required}</label>
                <select class="form-select" data-field-name="${field.name}">
                  <option value="">اختر ${field.label}</option>
                  ${(field.options || []).map(option => `<option value="${option}">${option}</option>`).join('')}
                </select>
              </div>
            `;
            break;
          case 'radio':
            fieldsHTML += `
              <div class="mb-3">
                <label class="form-label">${field.label}${required}</label>
                <div class="d-flex flex-column gap-2">
                  ${(field.options || []).map(option => `
                    <div class="form-check">
                      <input class="form-check-input" type="radio" name="${field.name}" value="${option}" data-field-name="${field.name}">
                      <label class="form-check-label">${option}</label>
                    </div>
                  `).join('')}
                </div>
              </div>
            `;
            break;
          case 'checkbox':
            fieldsHTML += `
              <div class="mb-3">
                <label class="form-label">${field.label}${required}</label>
                <div class="d-flex flex-column gap-2">
                  ${(field.options || []).map(option => `
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="${option}" data-field-name="${field.name}">
                      <label class="form-check-label">${option}</label>
                    </div>
                  `).join('')}
                </div>
              </div>
            `;
            break;
          case 'date':
            fieldsHTML += `
              <div class="mb-3">
                <label class="form-label">${field.label}${required}</label>
                <input type="date" class="form-control" data-field-name="${field.name}">
              </div>
            `;
            break;
          case 'file':
            fieldsHTML += `
              <div class="mb-3">
                <label class="form-label">${field.label}${required}</label>
                <input type="file" class="form-control" data-field-name="${field.name}">
              </div>
            `;
            break;
        }
      });
      
      container.innerHTML = fieldsHTML;
    }

    // ==================== PRODUCT MODAL ====================
    function openProductModal(productId) {
      const product = products.find(p => p.id === productId);
      if (!product) return;
      
      currentProductId = productId;
      const categoryName = product.mainCategoryId || 'غير مصنف';
      const modalBody = document.getElementById('productModalBody');
      let dynamicFieldsHTML = '';
      
      if (product.dynamicFields) {
        Object.entries(product.dynamicFields).forEach(([key, value]) => {
          const field = getFieldByName(product.mainCategoryId, key);
          const labelName = field?.label || key;
          let displayValue = value;
          
          if (Array.isArray(value)) {
            displayValue = value.join(', ');
          }
          
          dynamicFieldsHTML += `<p><strong>${labelName}:</strong> ${displayValue || 'غير محدد'}</p>`;
        });
      }
      
      modalBody.innerHTML = `
        <div class="text-center mb-3">
          <img src="${product.image || getDefaultImage()}" alt="${product.name}" style="max-width: 100%; max-height: 200px; border-radius: 8px;">
        </div>
        <h4>${product.name}</h4>
        ${product.sku ? `<p><strong>الكود:</strong> ${product.sku}</p>` : ''}
        ${product.barcode ? `<p><strong>الباركود:</strong> ${product.barcode}</p>` : ''}
        <p><strong>الفئة:</strong> ${categoryName}</p>
        <p><strong>السعر:</strong> ${formatPriceWithCurrency(product.price)} / ${product.unit || 'قطعة'}</p>
        <p><strong>الكمية:</strong> ${product.quantity || 0}</p>
        ${product.description ? `<p><strong>الوصف:</strong> ${product.description}</p>` : ''}
        ${dynamicFieldsHTML}
        <p><strong>تاريخ الإضافة:</strong> ${formatDate(product.createdAt)}</p>
        ${product.updatedAt !== product.createdAt ? `<p><strong>آخر تعديل:</strong> ${formatDate(product.updatedAt)}</p>` : ''}
      `;
      
      document.getElementById('productModal').classList.add('active');
    }

    function getFieldByName(categoryName, fieldName) {
      const fields = formStructure.categories[categoryName] || [];
      return fields.find(field => field.name === fieldName);
    }

    function closeProductModal() {
      document.getElementById('productModal').classList.remove('active');
      currentProductId = null;
    }

    function editCurrentProduct() {
      if (currentProductId) {
        closeProductModal();
        editProduct(currentProductId);
      }
    }

    function confirmDeleteProduct() {
      if (currentProductId) {
        const product = products.find(p => p.id === currentProductId);
        if (product) {
          openConfirmationModal(
            'تأكيد حذف المنتج',
            `هل أنت متأكد من أنك تريد حذف المنتج "${product.name}"؟ هذا الإجراء لا يمكن التراجع عنه.`,
            () => deleteCurrentProduct()
          );
        }
      }
    }

    function deleteCurrentProduct() {
      if (currentProductId) {
        products = products.filter(p => p.id !== currentProductId);
        saveData();
        closeProductModal();
        closeConfirmationModal();
        renderProducts();
        showToast('تم حذف المنتج بنجاح', 'success');
      }
    }

    // ==================== CATEGORY MANAGEMENT ====================
    function openCategoryModal() {
      document.getElementById('categoryModalTitle').textContent = 'إضافة فئة جديدة';
      document.getElementById('categoryForm').reset();
      currentEditingCategory = null;
      document.getElementById('categoryModal').classList.add('active');
    }

    function closeCategoryModal() {
      document.getElementById('categoryModal').classList.remove('active');
      currentEditingCategory = null;
    }

    function handleCategorySubmit(e) {
      e.preventDefault();
      
      const name = document.getElementById('categoryName').value.trim();
      const description = document.getElementById('categoryDescription').value.trim();
      
      if (!name) {
        showToast('يرجى إدخال اسم الفئة', 'warning');
        return;
      }
      
      if (currentEditingCategory) {
        if (currentEditingCategory !== name && formStructure.categories[name]) {
          showToast('اسم الفئة موجود مسبقاً', 'error');
          return;
        }
        
        if (currentEditingCategory !== name) {
          formStructure.categories[name] = formStructure.categories[currentEditingCategory];
          delete formStructure.categories[currentEditingCategory];
          
          products.forEach(product => {
            if (product.mainCategoryId === currentEditingCategory) {
              product.mainCategoryId = name;
            }
          });
        }
        
        showToast('تم تحديث الفئة بنجاح', 'success');
      } else {
        if (formStructure.categories[name]) {
          showToast('اسم الفئة موجود مسبقاً', 'error');
          return;
        }
        
        formStructure.categories[name] = [];
        showToast('تم إضافة الفئة بنجاح', 'success');
      }
      
      formStructure.lastUpdated = new Date().toISOString();
      saveData();
      closeCategoryModal();
      renderFormStructureEditor();
      updateMainCategoryOptions();
      updateCategoryFilter();
      
      if (currentEditingCategory && currentEditingCategory !== name) {
        selectCategory(name);
      } else if (!currentEditingCategory) {
        selectCategory(name);
      }
    }

    function editCategory(categoryName) {
      currentEditingCategory = categoryName;
      document.getElementById('categoryModalTitle').textContent = 'تعديل الفئة';
      document.getElementById('categoryName').value = categoryName;
      document.getElementById('categoryDescription').value = '';
     document.getElementById('categoryModal').classList.add('active');
    }

    function deleteCategory(categoryName) {
      openConfirmationModal(
        'تأكيد حذف الفئة',
        `هل أنت متأكد من حذف الفئة "${categoryName}"؟ سيتم حذف جميع الحقول المرتبطة بها.`,
        function() {
          delete formStructure.categories[categoryName];

          products.forEach(product => {
            if (product.mainCategoryId === categoryName) {
              product.mainCategoryId = '';
            }
          });

          formStructure.lastUpdated = new Date().toISOString();
          saveData();
          renderFormStructureEditor();
          updateMainCategoryOptions();
          updateCategoryFilter();
          showToast('تم حذف الفئة بنجاح', 'success');

          if (currentEditingCategory === categoryName) {
            currentEditingCategory = null;
            document.getElementById('addFieldBtn').disabled = true;
            document.getElementById('selectedCategoryTitle').textContent = 'اختر فئة';
            document.getElementById('fieldsList').innerHTML = `
              <div class="empty-state">
                <i class="fas fa-folder-open"></i>
                <h3>اختر فئة لبدء التحرير</h3>
                <p>اختر فئة من القائمة على اليسار لإدارة حقولها</p>
              </div>
            `;
            document.getElementById('formPreview').innerHTML = '<p class="text-muted text-center">ستظهر معاينة النموذج هنا</p>';
          }

          closeConfirmationModal();
        }
      );
    }

    // ==================== FIELD MANAGEMENT ====================
    function openFieldEditorModal() {
      if (!currentEditingCategory) {
        showToast('يرجى اختيار فئة أولاً', 'warning');
        return;
      }
      
      document.getElementById('fieldModalTitle').textContent = 'إضافة حقل جديد';
      document.getElementById('fieldForm').reset();
      document.getElementById('fieldOptionsSection').style.display = 'none';
      document.getElementById('fieldOptionsList').innerHTML = '';
      document.getElementById('fieldPreview').style.display = 'none';
      document.getElementById('validationErrors').style.display = 'none';
      currentEditingField = null;
      document.getElementById('fieldEditorModal').classList.add('active');
    }

    function closeFieldEditorModal() {
      document.getElementById('fieldEditorModal').classList.remove('active');
      currentEditingField = null;
    }

    function handleFieldTypeChange(e) {
      const fieldType = e.target.value;
      const optionsSection = document.getElementById('fieldOptionsSection');
      
      if (fieldType === 'select' || fieldType === 'radio' || fieldType === 'checkbox') {
        optionsSection.style.display = 'block';
        if (document.getElementById('fieldOptionsList').children.length === 0) {
          addFieldOption();
          addFieldOption();
        }
      } else {
        optionsSection.style.display = 'none';
      }
      
      updateFieldPreview();
    }

    function addFieldOption() {
      const optionsList = document.getElementById('fieldOptionsList');
      const optionIndex = optionsList.children.length;
      
      const optionDiv = document.createElement('div');
      optionDiv.className = 'dropdown-option';
      optionDiv.innerHTML = `
        <input type="text" placeholder="الخيار ${optionIndex + 1}" data-option-index="${optionIndex}">
        <button type="button" class="btn btn-xs btn-danger" onclick="this.parentElement.remove()">
          <i class="fas fa-trash"></i>
        </button>
      `;
      
      optionsList.appendChild(optionDiv);
    }

    function updateFieldKey() {
      const label = document.getElementById('fieldLabel').value.trim();
      const keyInput = document.getElementById('fieldKey');
      
      if (label && !currentEditingField) {
        const key = label
          .replace(/[^a-zA-Z0-9\u0600-\u06FF]/g, '_')
          .replace(/_+/g, '_')
          .replace(/^_|_$/g, '')
          .toLowerCase();
        
        keyInput.value = key;
      }
      
      updateFieldPreview();
    }

    function updateFieldPreview() {
      const label = document.getElementById('fieldLabel').value.trim();
      const fieldType = document.getElementById('fieldType').value;
      const previewContainer = document.getElementById('fieldPreview');
      const previewContent = document.getElementById('fieldPreviewContent');
      
      if (!label || !fieldType) {
        previewContainer.style.display = 'none';
        return;
      }
      
      previewContainer.style.display = 'block';
      
      let previewHTML = '';
      
      switch (fieldType) {
        case 'text':
          previewHTML = `<input type="text" class="form-control" placeholder="أدخل ${label}" disabled>`;
          break;
        case 'number':
          previewHTML = `<input type="number" class="form-control" placeholder="أدخل ${label}" disabled>`;
          break;
        case 'textarea':
          previewHTML = `<textarea class="form-control" placeholder="أدخل ${label}" rows="3" disabled></textarea>`;
          break;
        case 'select':
          const options = Array.from(document.querySelectorAll('#fieldOptionsList input'))
            .map(input => input.value.trim())
            .filter(val => val);
          
          if (options.length > 0) {
            previewHTML = `
              <select class="form-select" disabled>
                <option value="">اختر ${label}</option>
                ${options.map(option => `<option value="${option}">${option}</option>`).join('')}
              </select>
            `;
          } else {
            previewHTML = `<select class="form-select" disabled><option>لا توجد خيارات</option></select>`;
          }
          break;
        case 'radio':
          const radioOptions = Array.from(document.querySelectorAll('#fieldOptionsList input'))
            .map(input => input.value.trim())
            .filter(val => val);
          
          if (radioOptions.length > 0) {
            previewHTML = radioOptions.map(option => `
              <div class="form-check">
                <input class="form-check-input" type="radio" name="preview_radio" disabled>
                <label class="form-check-label">${option}</label>
              </div>
            `).join('');
          } else {
            previewHTML = '<p class="text-muted">لا توجد خيارات</p>';
          }
          break;
        case 'checkbox':
          const checkboxOptions = Array.from(document.querySelectorAll('#fieldOptionsList input'))
            .map(input => input.value.trim())
            .filter(val => val);
          
          if (checkboxOptions.length > 0) {
            previewHTML = checkboxOptions.map(option => `
              <div class="form-check">
                <input class="form-check-input" type="checkbox" disabled>
                <label class="form-check-label">${option}</label>
              </div>
            `).join('');
          } else {
            previewHTML = '<p class="text-muted">لا توجد خيارات</p>';
          }
          break;
        case 'date':
          previewHTML = `<input type="date" class="form-control" disabled>`;
          break;
        case 'file':
          previewHTML = `<input type="file" class="form-control" disabled>`;
          break;
      }
      
      previewContent.innerHTML = previewHTML;
    }

    function handleFieldSubmit(e) {
      e.preventDefault();
      
      const label = document.getElementById('fieldLabel').value.trim();
      const key = document.getElementById('fieldKey').value.trim();
      const fieldType = document.getElementById('fieldType').value;
      const required = document.getElementById('fieldRequired').checked;
      const isAttribute = document.getElementById('fieldAttribute').checked;
      
      if (!label || !key || !fieldType) {
        showToast('يرجى ملء جميع الحقول المطلوبة', 'warning');
        return;
      }
      
      const validationErrors = validateField(key, fieldType);
      if (validationErrors.length > 0) {
        showValidationErrors(validationErrors);
        return;
      }
      
      let options = [];
      if (fieldType === 'select' || fieldType === 'radio' || fieldType === 'checkbox') {
        options = Array.from(document.querySelectorAll('#fieldOptionsList input'))
          .map(input => input.value.trim())
          .filter(val => val);
        
        if (options.length === 0) {
          showToast('يرجى إضافة خيار واحد على الأقل', 'warning');
          return;
        }
      }
      
      const field = {
        name: key,
        label: label,
        type: fieldType,
        required: required,
        isAttribute: isAttribute,
        options: options
      };
      
      if (!formStructure.categories[currentEditingCategory]) {
        formStructure.categories[currentEditingCategory] = [];
      }
      
      if (currentEditingField !== null) {
        formStructure.categories[currentEditingCategory][currentEditingField] = field;
        showToast('تم تحديث الحقل بنجاح', 'success');
      } else {
        formStructure.categories[currentEditingCategory].push(field);
        showToast('تم إضافة الحقل بنجاح', 'success');
      }
      
      formStructure.lastUpdated = new Date().toISOString();
      saveData();
      closeFieldEditorModal();
      renderFieldsList(currentEditingCategory);
      updateFormPreview(currentEditingCategory);
    }

    function validateField(key, type) {
      const errors = [];
      
      if (!/^[a-zA-Z0-9_\u0600-\u06FF]+$/.test(key)) {
        errors.push('المفتاح يجب أن يحتوي على أحرف وأرقام وشرطات سفلية فقط');
      }
      
      if (formStructure.categories[currentEditingCategory]) {
        const existingFields = formStructure.categories[currentEditingCategory];
        const duplicateIndex = existingFields.findIndex((field, index) => 
          field.name === key && index !== currentEditingField
        );
        
        if (duplicateIndex !== -1) {
          errors.push('المفتاح مستخدم بالفعل في هذه الفئة');
        }
      }
      
      return errors;
    }

    function showValidationErrors(errors) {
      const errorsContainer = document.getElementById('validationErrors');
      const errorsList = errorsContainer.querySelector('ul');
      
      errorsList.innerHTML = errors.map(error => `<li>${error}</li>`).join('');
      errorsContainer.style.display = 'block';
    }

    function renderFieldsList(categoryName) {
      const container = document.getElementById('fieldsList');
      const fields = formStructure.categories[categoryName] || [];
      
      if (fields.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-plus-circle"></i>
            <h3>لا توجد حقول</h3>
            <p>اضغط على "إضافة حقل" لبدء إضافة حقول مخصصة</p>
          </div>
        `;
        return;
      }
      
      let fieldsHTML = '';
      fields.forEach((field, index) => {
        fieldsHTML += `
          <div class="field-item" data-field-index="${index}">
            <div class="field-header">
              <div>
                <div class="field-title">${field.label}</div>
                <div class="field-type">${getFieldTypeLabel(field.type)}</div>
              </div>
              <div class="field-actions">
                <button class="btn btn-xs btn-outline-primary" onclick="editField(${index})" title="تعديل">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-xs btn-outline-danger" onclick="deleteField(${index})" title="حذف">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
            ${field.required ? '<small class="text-danger">مطلوب</small>' : ''}
            ${field.isAttribute ? '<small class="text-info">خاصية</small>' : ''}
          </div>
        `;
      });
      
      container.innerHTML = fieldsHTML;
      
      if (fieldsSortable) {
        fieldsSortable.destroy();
      }
      
      fieldsSortable = new Sortable(container, {
        animation: 150,
        ghostClass: 'sortable-ghost',
        chosenClass: 'sortable-chosen',
        onEnd: function(evt) {
          const fields = [...formStructure.categories[categoryName]];
          const [removed] = fields.splice(evt.oldIndex, 1);
          fields.splice(evt.newIndex, 0, removed);
          formStructure.categories[categoryName] = fields;
          saveData();
        }
      });
    }

    function getFieldTypeLabel(type) {
      const labels = {
        text: 'نص',
        number: 'رقم',
        textarea: 'نص طويل',
        select: 'قائمة منسدلة',
        radio: 'اختيار فردي',
        checkbox: 'اختيار متعدد',
        date: 'تاريخ',
        file: 'ملف'
      };
      return labels[type] || type;
    }

    function editField(index) {
      const fields = formStructure.categories[currentEditingCategory];
      const field = fields[index];
      
      if (!field) return;
      
      currentEditingField = index;
      document.getElementById('fieldModalTitle').textContent = 'تعديل الحقل';
      document.getElementById('fieldLabel').value = field.label;
      document.getElementById('fieldKey').value = field.name;
      document.getElementById('fieldType').value = field.type;
      document.getElementById('fieldRequired').checked = field.required;
      document.getElementById('fieldAttribute').checked = field.isAttribute;
      
      handleFieldTypeChange({ target: { value: field.type } });
      
      if (field.options && field.options.length > 0) {
        const optionsList = document.getElementById('fieldOptionsList');
        optionsList.innerHTML = '';
        field.options.forEach(option => {
          const optionDiv = document.createElement('div');
          optionDiv.className = 'dropdown-option';
          optionDiv.innerHTML = `
            <input type="text" value="${option}" data-option-index="${optionsList.children.length}">
            <button type="button" class="btn btn-xs btn-danger" onclick="this.parentElement.remove()">
              <i class="fas fa-trash"></i>
            </button>
          `;
          optionsList.appendChild(optionDiv);
        });
      }
      
      updateFieldPreview();
      document.getElementById('fieldEditorModal').classList.add('active');
    }

    function deleteField(index) {
      openConfirmationModal(
        'تأكيد حذف الحقل',
        'هل أنت متأكد من حذف هذا الحقل؟',
        function() {
          formStructure.categories[currentEditingCategory].splice(index, 1);
          formStructure.lastUpdated = new Date().toISOString();
          saveData();
          renderFieldsList(currentEditingCategory);
          updateFormPreview(currentEditingCategory);
          showToast('تم حذف الحقل بنجاح', 'success');
          closeConfirmationModal();
        }
      );
    }

    function updateFormPreview(categoryName) {
      const previewContainer = document.getElementById('formPreview');
      const fields = formStructure.categories[categoryName] || [];
      
      if (fields.length === 0) {
        previewContainer.innerHTML = '<p class="text-muted text-center">ستظهر معاينة النموذج هنا</p>';
        return;
      }
      
      let previewHTML = '';
      fields.forEach(field => {
        const required = field.required ? ' *' : '';
        
        switch (field.type) {
          case 'text':
            previewHTML += `
              <div class="mb-3">
                <label class="form-label">${field.label}${required}</label>
                <input type="text" class="form-control" placeholder="أدخل ${field.label}" disabled>
              </div>
            `;
            break;
          case 'number':
            previewHTML += `
              <div class="mb-3">
                <label class="form-label">${field.label}${required}</label>
                <input type="number" class="form-control" placeholder="أدخل ${field.label}" disabled>
              </div>
            `;
            break;
          case 'textarea':
            previewHTML += `
              <div class="mb-3">
                <label class="form-label">${field.label}${required}</label>
                <textarea class="form-control" placeholder="أدخل ${field.label}" rows="3" disabled></textarea>
              </div>
            `;
            break;
          case 'select':
            previewHTML += `
              <div class="mb-3">
                <label class="form-label">${field.label}${required}</label>
                <select class="form-select" disabled>
                  <option value="">اختر ${field.label}</option>
                  ${(field.options || []).map(option => `<option value="${option}">${option}</option>`).join('')}
                </select>
              </div>
            `;
            break;
          case 'radio':
            previewHTML += `
              <div class="mb-3">
                <label class="form-label">${field.label}${required}</label>
                <div class="d-flex flex-column gap-2">
                  ${(field.options || []).map(option => `
                    <div class="form-check">
                      <input class="form-check-input" type="radio" name="preview_${field.name}" disabled>
                      <label class="form-check-label">${option}</label>
                    </div>
                  `).join('')}
                </div>
              </div>
            `;
            break;
          case 'checkbox':
            previewHTML += `
              <div class="mb-3">
                <label class="form-label">${field.label}${required}</label>
                <div class="d-flex flex-column gap-2">
                  ${(field.options || []).map(option => `
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" disabled>
                      <label class="form-check-label">${option}</label>
                    </div>
                  `).join('')}
                </div>
              </div>
            `;
            break;
          case 'date':
            previewHTML += `
              <div class="mb-3">
                <label class="form-label">${field.label}${required}</label>
                <input type="date" class="form-control" disabled>
              </div>
            `;
            break;
          case 'file':
            previewHTML += `
              <div class="mb-3">
                <label class="form-label">${field.label}${required}</label>
                <input type="file" class="form-control" disabled>
              </div>
            `;
            break;
        }
      });
      
      previewContainer.innerHTML = previewHTML;
    }

    // ==================== BARCODE SCANNER ====================
    function openBarcodeModal() {
      document.getElementById('barcodeModal').classList.add('active');
      document.getElementById('barcodeResult').style.display = 'none';
    }

    function closeBarcodeModal() {
      document.getElementById('barcodeModal').classList.remove('active');
      stopBarcodeScanner();
    }

    function searchByBarcode() {
      const barcode = document.getElementById('manualBarcodeInput').value.trim();
      if (!barcode) {
        showToast('يرجى إدخال رقم الباركود', 'warning');
        return;
      }
      
      const product = products.find(p => p.barcode === barcode);
      displayBarcodeResult(product, barcode);
    }

    function uploadBarcodeImage() {
      const fileInput = document.getElementById('barcodeImageInput');
      const file = fileInput.files[0];
      
      if (!file) {
        showToast('يرجى اختيار صورة', 'warning');
        return;
      }
      
      showToast('جاري تحليل الصورة...', 'info');
      
      setTimeout(() => {
        const mockBarcode = '1234567890123';
        const product = products.find(p => p.barcode === mockBarcode);
        displayBarcodeResult(product, mockBarcode);
      }, 2000);
    }

    function startBarcodeScanner() {
      const video = document.getElementById('barcodeVideo');
      const startBtn = document.getElementById('startCameraBtn');
      const stopBtn = document.getElementById('stopCameraBtn');
      
      navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
        .then(stream => {
          video.srcObject = stream;
          startBtn.classList.add('d-none');
          stopBtn.classList.remove('d-none');
          
          showToast('تم تشغيل الكاميرا', 'success');
          
          setTimeout(() => {
            const mockBarcode = '9876543210987';
            const product = products.find(p => p.barcode === mockBarcode);
            displayBarcodeResult(product, mockBarcode);
          }, 5000);
        })
        .catch(err => {
          showToast('لا يمكن الوصول إلى الكاميرا', 'error');
          console.error('Camera error:', err);
        });
    }

    function stopBarcodeScanner() {
      const video = document.getElementById('barcodeVideo');
      const startBtn = document.getElementById('startCameraBtn');
      const stopBtn = document.getElementById('stopCameraBtn');
      
      if (video.srcObject) {
        video.srcObject.getTracks().forEach(track => track.stop());
        video.srcObject = null;
      }
      
      startBtn.classList.remove('d-none');
      stopBtn.classList.add('d-none');
    }

    function displayBarcodeResult(product, barcode) {
      const resultContainer = document.getElementById('barcodeResult');
      
      if (product) {
        resultContainer.innerHTML = `
          <div class="alert alert-success">
            <i class="fas fa-check-circle"></i>
            <strong>تم العثور على المنتج!</strong>
          </div>
          <div class="card">
            <div class="card-body">
              <h5>${product.name}</h5>
              <p><strong>الباركود:</strong> ${barcode}</p>
              <p><strong>السعر:</strong> ${formatPriceWithCurrency(product.price)}</p>
              <p><strong>الكمية:</strong> ${product.quantity || 0}</p>
              <button class="btn btn-primary" onclick="closeBarcodeModal(); openProductModal('${product.id}')">
                <i class="fas fa-eye"></i> عرض التفاصيل
              </button>
            </div>
          </div>
        `;
      } else {
        resultContainer.innerHTML = `
          <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i>
            <strong>لم يتم العثور على منتج</strong>
          </div>
          <p>لا يوجد منتج برمز الباركود: ${barcode}</p>
          <button class="btn btn-primary" onclick="closeBarcodeModal(); navigateToPage('add')">
            <i class="fas fa-plus"></i> إضافة منتج جديد
          </button>
        `;
      }
      
      resultContainer.style.display = 'block';
    }

    // ==================== MODAL MANAGEMENT ====================
    function openConfirmationModal(title, message, onConfirm) {
      document.getElementById('confirmationTitle').textContent = title;
      document.getElementById('confirmationMessage').textContent = message;
      document.getElementById('confirmActionBtn').onclick = onConfirm;
      document.getElementById('confirmationModal').classList.add('active');
    }

    function closeConfirmationModal() {
      document.getElementById('confirmationModal').classList.remove('active');
    }

    function executeConfirmedAction() {
      // This will be overridden by the specific action
    }

    function closeAllModals() {
      document.querySelectorAll('.modal').forEach(modal => {
        modal.classList.remove('active');
      });
    }

    // ==================== FORM STRUCTURE IMPORT/EXPORT ====================
    function exportFormStructure() {
      const dataStr = JSON.stringify(formStructure, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      
      const link = document.createElement('a');
      link.href = URL.createObjectURL(dataBlob);
      link.download = `form-structure-${new Date().toISOString().slice(0, 10)}.json`;
      link.click();
      
      showToast('تم تصدير هيكل النماذج بنجاح', 'success');
    }

    function handleStructureImport(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          const structure = JSON.parse(event.target.result);
          
          if (structure.categories && structure.version) {
            openConfirmationModal(
              'تأكيد استبدال هيكل النماذج',
              'هل تريد استبدال هيكل النماذج الحالي بالهيكل المستورد؟',
              function() {
                formStructure = structure;
                saveData();
                renderFormStructureEditor();
                updateMainCategoryOptions();
                updateCategoryFilter();
                showToast('تم استيراد هيكل النماذج بنجاح', 'success');
                closeConfirmationModal();
              }
            );
          } else {
            showToast('ملف الاستيراد غير صالح', 'error');
          }
        } catch (error) {
          showToast('خطأ في قراءة الملف المستورد', 'error');
        }
      };
      reader.readAsText(file);
      e.target.value = '';
    }

    // ==================== STORE INFORMATION ====================
    function loadStoreInfo() {
      const storeInfo = JSON.parse(localStorage.getItem('storeInfo') || '{}');
      
      if (storeInfo.name) {
        document.getElementById('storeTitle').textContent = storeInfo.name;
        document.getElementById('storeName').value = storeInfo.name;
      }
      
      if (storeInfo.subtitle) {
        document.getElementById('storeSubtitle').textContent = storeInfo.subtitle;
        document.getElementById('storeSubtitleInput').value = storeInfo.subtitle;
      } else if (storeInfo.email || storeInfo.phone || storeInfo.website) {
        const subtitle = [storeInfo.email, storeInfo.phone, storeInfo.website]
          .filter(Boolean)
          .join(' | ');
        document.getElementById('storeSubtitle').textContent = subtitle;
      }
      
      if (storeInfo.email) {
        document.getElementById('storeEmail').value = storeInfo.email;
      }
      
      if (storeInfo.phone) {
        document.getElementById('storePhone').value = storeInfo.phone;
      }
      
      if (storeInfo.website) {
        document.getElementById('storeWebsite').value = storeInfo.website;
      }
      
      if (storeInfo.address) {
        document.getElementById('storeAddress').value = storeInfo.address;
      }
      
      if (storeInfo.logo) {
        document.getElementById('storeLogoImg').src = storeInfo.logo;
        document.getElementById('storeLogoImg').style.display = 'block';
        document.getElementById('storeLogoPreview').innerHTML = `
          <img src="${storeInfo.logo}" alt="Logo Preview" style="max-width: 100px; max-height: 100px; border-radius: 8px;">
        `;
      }
    }

    function saveStoreInfo() {
      const storeInfo = {
        name: document.getElementById('storeName').value.trim(),
        subtitle: document.getElementById('storeSubtitleInput').value.trim(),
        email: document.getElementById('storeEmail').value.trim(),
        phone: document.getElementById('storePhone').value.trim(),
        website: document.getElementById('storeWebsite').value.trim(),
        address: document.getElementById('storeAddress').value.trim(),
        logo: document.getElementById('storeLogoImg').src || null
      };
      
      localStorage.setItem('storeInfo', JSON.stringify(storeInfo));
      
      if (storeInfo.name) {
        document.getElementById('storeTitle').textContent = storeInfo.name;
      }
      
      if (storeInfo.subtitle) {
        document.getElementById('storeSubtitle').textContent = storeInfo.subtitle;
      } else if (storeInfo.email || storeInfo.phone || storeInfo.website) {
        const subtitle = [storeInfo.email, storeInfo.phone, storeInfo.website]
          .filter(Boolean)
          .join(' | ');
        document.getElementById('storeSubtitle').textContent = subtitle;
      } else {
        document.getElementById('storeSubtitle').textContent = 'مرجع المنتجات والمخزون المتقدم';
      }
      
      showToast('تم حفظ معلومات المتجر بنجاح', 'success');
    }

    function handleStoreLogoChange(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = (event) => {
        const logoSrc = event.target.result;
        document.getElementById('storeLogoImg').src = logoSrc;
        document.getElementById('storeLogoImg').style.display = 'block';
        document.getElementById('storeLogoPreview').innerHTML = `
          <img src="${logoSrc}" alt="Logo Preview" style="max-width: 100px; max-height: 100px; border-radius: 8px;">
        `;
      };
      reader.readAsDataURL(file);
    }

    // ==================== CURRENCY MANAGEMENT ====================
    function handleBaseCurrencyChange(e) {
      const newCurrency = e.target.value;
      applyBaseCurrency(newCurrency, true);
    }

    function applyBaseCurrency(newCurrency, showToastMessage = true) {
      baseCurrency = newCurrency;
      localStorage.setItem('baseCurrency', baseCurrency);
      document.getElementById('baseCurrencySelect').value = baseCurrency;
      
      const currency = currencyOptions[baseCurrency];
      document.getElementById('baseCurrencyHint').textContent = `سيتم عرض الأسعار بـ ${currency.name}`;
      
      if (showToastMessage) {
        showToast(`تم تغيير العملة إلى ${currency.name}`, 'success');
      }
      
      if (currentPage === 'home') {
        updateDashboard();
      }
      
      if (currentPage === 'products') {
        renderProducts();
      }
    }

    function formatPriceWithCurrency(price) {
      const currency = currencyOptions[baseCurrency];
      return new Intl.NumberFormat(currency.locale, {
        style: 'currency',
        currency: currency.code,
        minimumFractionDigits: currency.minimumFractionDigits
      }).format(price);
    }

    // ==================== UTILITY FUNCTIONS ====================
    function generateId() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    function getDefaultImage() {
      return `https://picsum.photos/seed/${generateId()}/300/200.jpg`;
    }

    function showToast(message, type = 'info') {
      const toastContainer = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      
      const iconMap = {
        success: 'fas fa-check-circle',
        error: 'fas fa-exclamation-circle',
        warning: 'fas fa-exclamation-triangle',
        info: 'fas fa-info-circle'
      };
      
      toast.innerHTML = `
        <i class="${iconMap[type]} toast-icon"></i>
        <span class="toast-message">${message}</span>
      `;
      
      toastContainer.appendChild(toast);
      
      setTimeout(() => {
        toast.classList.add('show');
      }, 100);
      
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
          toast.remove();
        }, 300);
      }, 3000);
    }

    function migrateFromOldStructure() {
      // Migration logic for older versions
      if (!formStructure.version || formStructure.version < '2.4.0') {
        // Add migration logic here if needed
        formStructure.version = '2.4.0';
        formStructure.lastUpdated = new Date().toISOString();
        saveData();
      }
    }

    // ==================== SAMPLE DATA ====================
    function getSampleProducts() {
      return [
        {
          id: generateId(),
          name: 'لابتوب Dell Inspiron',
          sku: 'DELL-001',
          barcode: '1234567890123',
          mainCategoryId: 'إلكترونيات',
          unit: 'piece',
          price: 3500,
          quantity: 10,
          description: 'لابتوب عالي الأداء مع معالج Intel Core i7',
          image: 'https://picsum.photos/seed/laptop1/300/200.jpg',
          dynamicFields: {
            brand: 'Dell',
            warranty: '2 سنة'
          },
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString()
        },
        {
          id: generateId(),
          name: 'هاتف Samsung Galaxy',
          sku: 'SAMSUNG-001',
          barcode: '2345678901234',
          mainCategoryId: 'هواتف',
          unit: 'piece',
          price: 2500,
          quantity: 25,
          description: 'هاتف ذكي بكاميرا احترافية',
          image: 'https://picsum.photos/seed/phone1/300/200.jpg',
          dynamicFields: {
            color: 'أسود',
            storage: '128GB'
          },
          createdAt: new Date(Date.now() - 86400000).toISOString(),
          updatedAt: new Date(Date.now() - 86400000).toISOString()
        },
        {
          id: generateId(),
          name: 'تيشيرت رجالي',
          sku: 'SHIRT-001',
          barcode: '3456789012345',
          mainCategoryId: 'ملابس',
          unit: 'piece',
          price: 120,
          quantity: 50,
          description: 'تيشيرت قطني مريح',
          image: 'https://picsum.photos/seed/shirt1/300/200.jpg',
          dynamicFields: {
            size: 'L',
            material: 'قطن'
          },
          createdAt: new Date(Date.now() - 172800000).toISOString(),
          updatedAt: new Date(Date.now() - 172800000).toISOString()
        }
      ];
    }

    function getSampleFormStructure() {
      return {
        version: "2.4.0",
        lastUpdated: new Date().toISOString(),
        categories: {
          "إلكترونيات": [
            {
              name: "brand",
              label: "العلامة التجارية",
              type: "text",
              required: true,
              isAttribute: true,
              options: []
            },
            {
              name: "warranty",
              label: "الضمان",
              type: "select",
              required: false,
              isAttribute: false,
              options: ["6 أشهر", "سنة", "سنتان", "3 سنوات"]
            }
          ],
          "هواتف": [
            {
              name: "color",
              label: "اللون",
              type: "radio",
              required: true,
              isAttribute: true,
              options: ["أسود", "أبيض", "أزرق", "ذهبي"]
            },
            {
              name: "storage",
              label: "مساحة التخزين",
              type: "select",
              required: true,
              isAttribute: true,
              options: ["64GB", "128GB", "256GB", "512GB"]
            }
          ],
          "ملابس": [
            {
              name: "size",
              label: "المقاس",
              type: "select",
              required: true,
              isAttribute: true,
              options: ["XS", "S", "M", "L", "XL", "XXL"]
            },
            {
              name: "material",
              label: "المادة",
              type: "text",
              required: false,
              isAttribute: false,
              options: []
            }
          ]
        }
      };
    }

    // ==================== INITIALIZATION COMPLETE ====================
    console.log('🚀 Pushdarah Product Manager v2.4.0 - Dynamic Fields System Loaded Successfully');
  </script>
</body>
</html>